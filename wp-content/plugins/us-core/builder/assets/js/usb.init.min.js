!function($,_undefined){const _window=window;_window.$ush=_window.$ush||{};_window.usGlobalData=_window.usGlobalData||{};_window.NOTIFY_TYPE={ERROR:'error',INFO:'info',SUCCESS:'success'};_window.HISTORY_TYPE={REDO:'redo',UNDO:'undo'};_window.ACTION_CONTENT={CALLBACK:'callback',CREATE:'create',MOVE:'move',REMOVE:'remove',UPDATE:'update'};var _$tmp={xhr:{}};var _$config={actions:{site_settings:'us-site-settings',},};function USBInit(container){const self=this;self.iframe;self.iframeIsReady=!1;self._hotkeyStates={};_window.onmessage=self._onMessage.bind(self);self._events={iframeReady:$ush.debounce(self._iframeReady.bind(self),0),urlManager:self._urlManager.bind(self),keydown:self._keydown.bind(self),};$(()=>{self.$document=$(document);self.$body=$('body');self.$container=$(container);self.$panel=$('#usb-panel');self.$panelBody=$('.usb-panel-body',self.$panel);self.$iframe=$('iframe',self.$container);self.iframe=self.$iframe[0];if(self.$container.is('[onclick]')){$usb.setConfig($.extend(_$config,self.$container[0].onclick()||{}));self.$container.removeAttr('onclick')}
if(self.$iframe.is('[data-src]')){self.$iframe.attr('src',self.$iframe.data('src')).removeAttr('data-src')}
self.$document.on('keydown',self._events.keydown);$('html').attr('data-useragent',$ush.ua);if($ush.isMacOS){$('[data-macos-shortcuts]',self.$container).each((_,node)=>{const $node=$(node);$node.text($node.data('macos-shortcuts')||'')})}
self._urlManager(self.urlManager.getDataOfChange())});self.on('iframe.pageDataLoaded',self._events.iframeReady).on('urlManager.changed',self._events.urlManager)}
const prototype=USBInit.prototype;$.extend(prototype,$ush.mixinEvents,{_urlManager:function(state){const self=this;var action=state.setParams.action;if($usbcore.indexOf(action,self.config('actions',[]))===-1){action=self.config('actions.site_settings')}
self.$body.usMod('action',action||!1)},_onMessage:function(e){const self=this;var data;try{data=JSON.parse(e.data)}catch(err){return}
if(data instanceof Array&&data[0]==='usb'&&data[1]!==_undefined){self.trigger(data[1],data[2]||[])}},_iframeReady:function(){const self=this;self.iframeIsReady=!0;if(!self.iframe.contentDocument){return}
self.preview.hidePreloader();self.trigger('iframeReady')},_keydown:function(e){const self=this;if(e.type!=='keydown'){return}
var isCmd=(e.metaKey||e.ctrlKey),isUndo=(isCmd&&!e.shiftKey&&e.which===90),isRedo=(isCmd&&e.shiftKey&&e.which===90),isSave=(isCmd&&!e.shiftKey&&e.which===83);if($.isPlainObject(self._hotkeyStates)){$.extend(self._hotkeyStates,{'ctrl+z':isUndo,'ctrl+shift+z':isRedo,'ctrl+s':isSave});for(const combination in self._hotkeyStates){if(self._hotkeyStates[combination]===!0){self.trigger(`hotkeys.${combination}`)}}}
if(isSave||((isUndo||isRedo)&&$.inArray($ush.toLowerCase(e.target.tagName||''),['input','textarea'])>-1)){e.preventDefault()}},});$.extend(prototype,{postMessage:function(eventType,extraParams){const self=this;if(!self.iframeIsReady){return}
self.iframe.contentWindow.postMessage(JSON.stringify(['usb',eventType,extraParams]))},triggerDocument:function(eventType,extraParams){this.$document.trigger('usb.'+eventType,extraParams)}});$.extend(prototype,{find:function(path,defaultValue){return path&&$usbcore.deepFind(this,path,defaultValue||_undefined)},reloadPreview:function(){const self=this;if(!self.iframeIsReady){return}
self.preview.showPreloader();self.iframe.contentWindow.location.reload()},setConfig:function(config){if($.isPlainObject(config)){_$config=$.extend(!0,_$config,config);$usbcore.cache('config').flush()}},config:function(path,defaultValue){if($ush.isUndefined(path)){return $ush.clone(_$config)}
return $usbcore.cache('config').get(path,function(){return $usbcore.deepFind(_$config,path,defaultValue)})},licenseIsActivated:function(){return!!this.config('license_is_activated',!1)},licenseIsRealActivated:function(){return!!this.config('license_is_real_activated',!1)},hotkeys:function(){const args=$ush.toArray(arguments);for(const i in args)if(this._hotkeyStates[''+args[i]]===!0){return!0}
return!1},log:function(){var args=$ush.toArray(arguments);if(!args.length){args=['log: called with no params']}
console.log.apply(null,args)},getTextTranslation:function(key){if(!key){return ''}
return(_window.usGlobalData.textTranslations||{})[key]||key},_normalizeInstructions:function(instructions){if(!!instructions&&!Array.isArray(instructions)&&instructions!==!0){instructions=$.isPlainObject(instructions)?[instructions]:[]}
return instructions},buildString:function(template,params){if(!$.isPlainObject(params)){params={}}
var self=this,pattern=$ush.escapePcre($usb.config('startSymbol','{%'));pattern+='([A-z\\_\\d]+)';pattern+=$ush.escapePcre($usb.config('endSymbol','%}'));return(''+template).replace(new RegExp(pattern,'gm'),(_,varName)=>{return ''+(params[varName]||'')})},getAttachment:function(id){if(!id||!wp.media){return}
return wp.media.attachment(id)},getAttachmentUrl:function(id){if(!id){return ''}
return(this.getAttachment(id)||{get:$.noop}).get('url')||''},ajax:function(requestId,settings){const self=this;if(!requestId||$.isEmptyObject(settings)){return}
settings=$ush.clone(settings,{data:{},abort:$.noop,complete:$.noop,error:$.noop,success:$.noop});if(!$ush.isUndefined(_$tmp.xhr[requestId])){_$tmp.xhr[requestId].abort();if(typeof settings.abort==='function'){settings.abort.call(self,requestId)}}
_$tmp.xhr[requestId]=$.ajax({data:$.extend({},self.config('ajaxArgs',{}),settings.data),dataType:'json',type:'post',url:_window.ajaxurl,cache:!1,success:(res)=>{delete _$tmp.xhr[requestId];if(!res.success&&$ush.isUndefined(res.data.usb_ignore_standard_notify)){var message=($ush.isUndefined(res.data)?'Invalid `res.data`':res.data.message);self.notify.add('XHR: '+message,NOTIFY_TYPE.ERROR)}
if(typeof settings.success==='function'){settings.success.call(self,res)}},error:(jqXHR,textStatus,errorThrown)=>{if(textStatus==='abort'){return}
if(typeof settings.error==='function'){settings.error.call(self,requestId)}
if(!errorThrown){errorThrown='Request was not sent'}
self.log('XHR.error:'+errorThrown,jqXHR,requestId)},complete:(_,textStatus)=>{if(textStatus==='abort'){return}
if(typeof settings.complete==='function'){settings.complete.call(self,requestId,textStatus)}}})},redirect:function(url){const self=this;if(url&&typeof url==='string'){self.iframeIsReady=!1;location.href=url}}});_window.$usb=new USBInit('#usb-wrapper')}(jQuery);!function($,_undefined){const _window=window;_window.$ush=_window.$ush||{};const SPACE_REGEXP=/\p{Zs}/u;var _$$cache={};function Data(namespace){const self=this;self._$data={};self._namespace=namespace};dataPrototype=Data.prototype;dataPrototype.isEmpty=function(){return $.isEmptyObject(this._$data)};dataPrototype.has=function(key){return!$ush.isUndefined(this._$data[key])};dataPrototype.get=function(key,value){const self=this;if(!self.has(key)){if(typeof value==='function'){value=value.call(self)}
if(arguments.length===2){self._$data[key]=value}}
return self._$data[key]};dataPrototype.set=function(){const self=this;const args=$ush.toArray(arguments);var values={};if(args.length==2&&typeof args[0]==='string'){values[args[0]]=args[1]}else if($.isPlainObject(args[0])){values=args[0]}
$.extend(self._$data,values);return self};dataPrototype.data=function(){return this._$data};dataPrototype.remove=function(key){const self=this;const args=$ush.toArray(arguments);for(const i in args){if(self.has(args[i])){delete self._$data[args[i]]}}
return self};dataPrototype.flush=function(){const self=this;if(!$ush.isUndefined(_$$cache[self._namespace])){delete _$$cache[self._namespace]}};$usbcore={};$usbcore.diffPlainObject=function(objectA,objectB){const self=this;const result={};if($ush.comparePlainObject(objectA,objectB)){return result}
for(const k in objectA){if($.isPlainObject(objectA[k])){const diff=self.diffPlainObject(objectA[k],$.isPlainObject(objectB[k])?objectB[k]:{});if(!$.isEmptyObject(diff)){result[k]=diff}}else if($ush.isUndefined(objectB[k])||objectA[k]!==objectB[k]){result[k]=objectA[k]}}
return $.isEmptyObject(result)?result:$ush.clone(result)};$usbcore.clearPlainObject=function(data,props){const self=this;if(!$.isPlainObject(data)){data={}}
if($ush.isUndefined(props)){return data}
if(!Array.isArray(props)){props=[''+props]}
data=$ush.clone(data);for(const k in props){const prop=props[k];if(!data.hasOwnProperty(prop)){continue}
delete data[prop]}
return data}
$usbcore.indexOf=function(value,data){const self=this;if($.isPlainObject(data)){data=Object.values(data)}
if(Array.isArray(data)){return data.indexOf(typeof value==='number'?value:''+value)}
return-1};$usbcore.deepFind=function(dataObject,path,defaultValue){const self=this;path=(''+path).replace(/[^A-z\d\-\_\.]/g,'').trim();if(!path){return defaultValue}
if(path.indexOf('.')>-1){path=path.split('.')}else{path=[path]}
var result=(typeof dataObject=='object')?dataObject:{};for(const k in path){result=result[path[k]];if($ush.isUndefined(result)){return defaultValue}}
return result};$usbcore.$addClass=function(node,className){const self=this;if($ush.isNode(node)&&className){node.classList.add(className)}
return self};$usbcore.$removeClass=function(node,className){const self=this;if($ush.isNode(node)&&className){(''+className).split(SPACE_REGEXP).map((itemClassName)=>{if(!itemClassName){return}
node.classList.remove(itemClassName)})}
return self};$usbcore.$toggleClass=function(node,className,state){const self=this;if($ush.isNode(node)&&className){self[!!state?'$addClass':'$removeClass'](node,className)}
return self};$usbcore.$hasClass=function(node,className){const self=this;if($ush.isNode(node)&&className){var classList=(''+className).split(SPACE_REGEXP);for(const i in classList){className=''+classList[i];if(!className){continue}
if(self.indexOf(className,(''+node.className).split(SPACE_REGEXP))>-1){return!0}}}
return!1};$usbcore.$attr=function(node,name,value){const self=this;if(!$ush.isNode(node)||!name){return}
if(!$ush.isUndefined(value)){node.setAttribute(name,value);return self}else if(!!node.getAttribute){return node.getAttribute(name)||''}
return};$usbcore.$remove=function(node){const self=this;if($ush.isNode(node)){node.remove()}
return self};$usbcore.cache=function(namespace){const self=this;if(!$.isPlainObject(_$$cache)){_$$cache={}}
if($ush.isUndefined(_$$cache[namespace])){_$$cache[namespace]=new Data(namespace)}
if($ush.isUndefined(namespace)){console.log('Error: Namespace not set',[namespace])}
return _$$cache[namespace]};$usbcore.setTextToCaretPosition=function(node,text){if($ush.isNode(node)){var position=$ush.parseInt(node.selectionStart),value=node.value;text=$ush.toString(text).trim();node.value=value.slice(0,position)+text+value.slice(position);$ush.setCaretPosition(node,position+text.length||value.length)}};_window.$usbcore=$usbcore}(jQuery);!function($,_undefined){var _history=history,_location=location,_window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};const _RESERVED_PARAMS_=['post'];var _$locationHref=_location.href;var _$url=new URL(_$locationHref);function URLManager(){const self=this;_window.onpopstate=function(e){self.setUrl(_location);var state=$.isPlainObject(e.state)?$ush.clone(e.state):{};$.extend(state,self.getDataOfChange())
$usb.trigger('urlManager.changed',state);_$locationHref=_location.href}}
$.extend(URLManager.prototype,{setUrl:function(url){_$url=new URL(url);return this},getHref:function(){return _location.href},buildHref:function(){return _$url.toString()},hasChange:function(){return this.getHref()!==this.buildHref()},hasParam:function(key,value){if(typeof key==='string'){var hasKey=_$url.searchParams.has(key);if(!value){return hasKey}
return hasKey&&_$url.searchParams.get(key)===value}
return!1},setParam:function(key,value){if(typeof key==='string'){if($ush.isUndefined(value)){_$url.searchParams.delete(key)}else{_$url.searchParams.set(key,value||'')}}
return this},setParams:function(params){const self=this;if($.isPlainObject(params)){for(const k in params){if(params[k]){self.setParam(k,params[k])}}}
return self},getParam:function(key){if(key&&this.hasParam(key)){return _$url.searchParams.get(key)}
return _undefined},getParams:function(keys){const self=this;const result={};_$url.searchParams.forEach((value,key)=>{if(Array.isArray(keys)&&keys.indexOf(key)===-1){return}
result[key]=value});return result},removeParam:function(key){const self=this;if(self.hasParam(key)){_$url.searchParams.delete(key)}
return self},removeParams:function(keys){const self=this;if(Array.isArray(keys)){keys.map(self.removeParam.bind(self))}
return self},getDataOfChange:function(){const self=this;const data={setParams:{},oldParams:{}};(new URL(_$locationHref)).searchParams.forEach((value,key)=>{if($usbcore.indexOf(key,_RESERVED_PARAMS_)===-1&&!self.hasParam(key,value)){data.oldParams[key]=value}});_$url.searchParams.forEach((value,key)=>{if($usbcore.indexOf(key,_RESERVED_PARAMS_)===-1||(!$ush.isUndefined(data.oldParams[key])&&data.oldParams[key]!==value)){data.setParams[key]=value}});return data},push:function(state){const self=this;if(!self.hasChange()){return}
state=$.isPlainObject(state)?$ush.clone(state):{};$.extend(state,self.getDataOfChange());_history.pushState(state,'',self.buildHref());$usb.trigger('urlManager.changed',state);_$locationHref=_location.href}});$usb.urlManager=new URLManager}(jQuery);!function($,_undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};function Notify(container){const self=this;self._events={close:self._close.bind(self)};$(()=>{self.$container=$(container);$usb.$document.on('click','.usb_action_notification_close',self._events.close)})}
$.extend(Notify.prototype,{isReady:function(){return!$ush.isUndefined(this.$container)},add:function(message,type){const self=this;var delayAutoClose=4000,$notification=self.$container.clone().removeClass('hidden');if(!!type&&$usbcore.indexOf(type,NOTIFY_TYPE)>-1){$notification.addClass('type_'+type)}
if(type!==NOTIFY_TYPE.ERROR){$notification.addClass('auto_close').data('handle',$ush.timeout(()=>{$notification.find('.usb_action_notification_close').trigger('click')},delayAutoClose))}
$notification.find('span').html(''+message);$usb.$panel.append($notification)},_close:function(e){var $notification=$(e.target).closest('.usb-notification'),handle=$notification.data('handle');if(!!handle){$ush.clearTimeout(handle)}
$notification.fadeOut('fast',()=>{$notification.remove()})},closeAll:function(){$('.usb-notification',$usb.$body).fadeOut('fast',function(){$(this).remove()})}});$usb.notify=new Notify('.usb-notification')}(jQuery);!function($,_undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};function Panel(container){const self=this;self._events={switch:self._switch.bind(self),urlManager:self._urlManager.bind(self),};$(()=>{self.$container=$(container);self.$header=$('.usb-panel-header',self.$container);self.$title=$('.usb-panel-header-title',self.$header);self.$body=$('.usb-panel-body',self.$container);self.$messages=$('.usb-panel-messages',self.$container);self.$actionSaveChanges=$('.usb_action_save_changes',self.$container);self.$container.on('click','.usb-panel-switcher',self._events.switch).on('click','.usb_action_save_changes',()=>{$usb.trigger('panel.saveChanges')})});$usb.on('urlManager.changed',self._events.urlManager)}
$.extend(Panel.prototype,{isReady:function(){return!$ush.isUndefined(this.$container)},isShow:function(){return!$usb.$body.hasClass('hide_sidebars')},clearBody:function(){this.hideMessage();$usb.trigger('panel.clearBody')},resetBodyScroll:function(){this.$body[0].scrollTo(0,0)},setTitle:function(title,isTranslationKey){const self=this;if(self.isReady()&&title){if(isTranslationKey){title=$usb.getTextTranslation(title)}
self.$title.html(typeof title==='string'?title:'no_title')}},showMessage:function(text){const self=this;self.clearBody();$usb.trigger('panel.showMessage',text);self.$messages.removeClass('hidden').html(text)},hideMessage:function(){const self=this;if(self.isReady()){self.$messages.addClass('hidden').html('')}},_switch:function(){const self=this;$usb.$body.toggleClass('hide_sidebars',self.isShow());$usb.trigger('panel.switch',self.isShow());$usb.postMessage('changeSwitchPanel')},showPreloader:function(){this.$container.addClass('show_preloader')},hidePreloader:function(){this.$container.removeClass('show_preloader')},switchSaveButton:function(enable,isLoading){this.$actionSaveChanges.prop('disabled',!enable).toggleClass('disabled',!enable).toggleClass('loading',isLoading===!0?enable:!1)},_urlManager:function(state){const self=this;if(!self.isReady()){return}
const _siteSettings=$usb.config('actions.site_settings');if(state.setParams.action===_siteSettings){$('.usb_action_show_add_elms',self.$header).addClass('hidden');$('.usb_action_go_to_back',self.$header).removeClass('hidden')}
else if(state.oldParams.action===_siteSettings){$('.usb_action_show_add_elms',self.$header).removeClass('hidden');$('.usb_action_go_to_back',self.$header).addClass('hidden')}}});$usb.panel=new Panel('#usb-panel')}(jQuery);!function($,_undefined){const _window=window;const ceil=Math.ceil;const max=Math.max;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};const _DEFAULT_RESPONSIVE_SCREEN_='default';var _$tmp={currentResponsiveScreen:'default',resizeControlWidth:20,};function Preview(container){const self=this;self._events={endResize:self._endResize.bind(self),hideToolbar:self._hideToolbar.bind(self),maybeResize:self._maybeResize.bind(self),maybeStartResize:self._maybeStartResize.bind(self),switchResponsiveScreen:self._switchResponsiveScreen.bind(self),switchToolbar:self._switchToolbar.bind(self),urlManager:self._urlManager.bind(self),};$(()=>{self.$container=$(container);self.$screen=$('.usb-preview-screen',self.$container);self.$wrapper=$('.usb-preview-wrapper',self.$container);self.$inputWidth=$('input[name=screenWidth]',self.$container);self.$inputHeight=$('input[name=screenHeight]',self.$container);self.$actionSwitchToolbar=$('.usb_action_switch_toolbar',$usb.$panel);_$tmp.resizeControlWidth=$ush.parseInt($('[data-resize-control]',self.$screen).width());self.$container.on('click','.usb_action_hide_toolbar',self._events.hideToolbar).on('click','[data-responsive-state]',self._events.switchResponsiveScreen);$usb.$document.on('mousedown','[data-resize-control]',self._events.maybeStartResize).on('mousemove',self._events.maybeResize).on('mouseup',self._events.endResize);$usb.$panel.on('click','.usb_action_switch_toolbar',self._events.switchToolbar);self._urlManager($usb.urlManager.getDataOfChange())});$usb.on('urlManager.changed',self._events.urlManager);self.on('document.syncResponsiveState',(screenName)=>{if(self.isScreenName(screenName)){$usb.triggerDocument('syncResponsiveState',screenName)}})}
const prototype=Preview.prototype;$.extend(prototype,$ush.mixinEvents,{isReady:function(){return!$ush.isUndefined(this.$container)},isShow:function(){return $usb.urlManager.hasParam('screen')},showPreloader:function(){this.$wrapper.addClass('show_preloader')},hidePreloader:function(){this.$wrapper.removeClass('show_preloader')},isScreenName:function(screen){return screen&&$usbcore.indexOf(screen,$usb.config('responsiveStates',[]))>-1},getCurrentOffset:function(){const rect=$ush.$rect($usb.iframe);return{y:rect.y||0,x:rect.x||0}},_urlManager:function(state){const self=this;const currentScreen=state.setParams.screen;if(!self.isReady()||(currentScreen===_$tmp.currentResponsiveScreen&&self.$container.hasClass('responsive_mode'))){return}
if(currentScreen){self.showToolbar(currentScreen)}else if(state.oldParams.screen){self.hideToolbar()}},showToolbar:function(screen){const self=this;self.$container.addClass('responsive_mode');self.$actionSwitchToolbar.addClass('active');self.setResponsiveScreen(screen||_DEFAULT_RESPONSIVE_SCREEN_)},hideToolbar:function(){const self=this;self.$container.removeClass('responsive_mode');self.$actionSwitchToolbar.removeClass('active');self.setResponsiveScreen(_DEFAULT_RESPONSIVE_SCREEN_);self.$screen.removeAttr('style').removeData('_width');$usb.$iframe.removeAttr('style')},_hideToolbar:function(){$usb.urlManager.removeParam('screen').push()},_switchToolbar:function(){const self=this;const urlManager=$usb.urlManager;if(!self.isShow()){urlManager.setParam('screen',_DEFAULT_RESPONSIVE_SCREEN_)}else{urlManager.removeParam('screen')}
urlManager.push()},_switchResponsiveScreen:function(e){const screen=$usbcore.$attr(e.target,'data-responsive-state');this.setResponsiveScreen(screen);$usb.urlManager.setParam('screen',screen).push()},_setScreenWidth:function(width){const self=this;var resizeControlWidth=_$tmp.resizeControlWidth*2,breakpoint=$usb.config('breakpoints.'+_$tmp.currentResponsiveScreen,{}),maxWidth=$ush.parseInt(breakpoint.max_width)+resizeControlWidth,minWidth=max($ush.parseInt(breakpoint.min_width),$ush.parseInt($usb.config('preview.minHeight')))+resizeControlWidth;if(width>=maxWidth){width=maxWidth}
if(width<=minWidth){width=minWidth}
self.$inputWidth.val(width-resizeControlWidth);self.$screen.css('width',width)},setResponsiveScreen:function(screen){const self=this;if(!self.isScreenName(screen)){return}
self.$wrapper.usMod('responsive_state',screen);self.trigger('document.syncResponsiveState',screen);$('[data-responsive-state]',self.$container).removeClass('active').filter(`[data-responsive-state="${screen}"]`).addClass('active');_$tmp.currentResponsiveScreen=screen;const resizeControlWidth=_$tmp.resizeControlWidth;if(!self.$inputHeight.val()){self.$inputHeight.val($ush.parseInt(self.$screen.height())-resizeControlWidth||'')}
var containerWidth=$ush.parseInt(self.$container.width()),width=($usb.config(`breakpoints.${screen}.breakpoint`)||containerWidth)+(resizeControlWidth*2);if(width>=containerWidth){width=containerWidth}
self._setScreenWidth(width);self.$inputHeight.val(ceil($usb.$iframe.height()))},setFieldResponsiveScreen:$ush.debounce(function(){const self=this;if(self.isShow()){self.trigger('document.syncResponsiveState',_$tmp.currentResponsiveScreen)}},100),fieldSetResponsiveScreen:function(screen){const self=this;if(!self.isShow()){self.showToolbar(screen)}else{self.setResponsiveScreen(screen)}
$usb.urlManager.setParam('screen',screen).push()},_maybeStartResize:function(e){const self=this;if(!self.isShow()){return}
const $screen=self.$screen;$usbcore.cache('temp').set('resizeData',{resizeControl:$usbcore.$attr(e.target,'data-resize-control'),startHeight:$ush.parseInt($screen.height()),startWidth:$ush.parseInt($screen.width()),startPageX:e.pageX,startPageY:e.pageY});$screen.addClass('resizable')},_maybeResize:function(e){const self=this;if(!self.isShow()){return}
var resizeData=$usbcore.cache('temp').data().resizeData;if($.isEmptyObject(resizeData||{})){return}
var resizeControlWidth=_$tmp.resizeControlWidth,resizeControl=resizeData.resizeControl,isRightControl=resizeControl=='right';if(resizeControl=='left'||isRightControl){var pageX=e.pageX,offsetX=(resizeData.startPageX-pageX)*2,width=(isRightControl?resizeData.startWidth-offsetX:resizeData.startWidth+offsetX);var currentResponsiveScreen=_$tmp.currentResponsiveScreen;if(currentResponsiveScreen==_DEFAULT_RESPONSIVE_SCREEN_){var maxWidth=$ush.parseInt($usb.config(`breakpoints.${currentResponsiveScreen}.max_width`)),windowWidth=(_window.innerWidth-1);if(maxWidth&&windowWidth<maxWidth&&(!pageX||pageX==windowWidth)){width=$ush.parseInt(self.$screen.width())+10;if(width>=maxWidth){resizeData.startWidth=maxWidth+resizeControlWidth;resizeData.startPageX=0}}}
self._setScreenWidth(width)}
if(resizeControl=='bottom'){var height=resizeData.startHeight-(resizeData.startPageY-e.pageY);var minHeight=$usb.config('preview.minHeight',320)+resizeControlWidth;if(height<minHeight){height=minHeight}
var wrapperHeight=$ush.parseInt(self.$wrapper.height());if(wrapperHeight&&height>wrapperHeight){height=wrapperHeight}
self.$inputHeight.val(height-resizeControlWidth);self.$screen.css('height',height)}},_endResize:function(){const self=this;if(!self.isShow()){return}
self.$screen.removeClass('resizable');$usbcore.cache('temp').remove('resizeData')}});$usb.preview=new Preview('#usb-preview')}(jQuery);!function($,_undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};function CSSGenerator(collections){const self=this;if(!$.isPlainObject(collections)){return ''}
var result='';for(var screen in collections){if($.isEmptyObject(collections[screen])){continue}
var collection=collections[screen],styles='';for(var name in collection){if(!name||!$.isPlainObject(collection[name])){continue}
var props=collection[name];for(var prop_name in props){var prop_value=''+props[prop_name];if(!prop_name&&prop_value===''){continue}
if(prop_value.indexOf(' ')>-1&&prop_value.indexOf(',')==-1&&prop_name.indexOf('font-family')>-1){prop_value='"'+prop_value+'"'}
styles+=prop_name+':'+prop_value;if(prop_name.indexOf('--')!==0){styles+='!important'}
styles+=';'}
if(styles){if(name.indexOf(':')!==0){name='.'+name}
styles=name+'{'+styles+'}'}}
const breakpoint=$usb.config(`breakpoints.${screen}.media`,'');if(screen!=='default'&&breakpoint){result+='@media '+breakpoint+'{'+styles+'}'}else{result+=styles}}
return result+''}
$usb.cssGenerator=CSSGenerator}(jQuery);!function($,_undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};function Fonts(){}
$.extend(Fonts.prototype,{setGoogleFonts:function(themeOptions){const self=this;if(!$usb.iframeIsReady){return}
const $node=$('link[id='+$usb.config('typography.fonts_id')+']',$usb.iframe.contentDocument);if($node.length){$node.attr('href',self._getGoogleEndpoint(themeOptions))}else{$('head',$usb.iframe.contentDocument).append('<link id="'+$usb.config('typography.fonts_id')+'" rel="stylesheet" href="'+self._getGoogleEndpoint(themeOptions)+'" media="all">')}},_getGoogleEndpoint:function(themeOptions){const self=this;var usedFonts={},config=$usb.config('typography',{}),googleFonts=config.googleFonts||{},additionalGoogleFonts=config.usedGoogleFonts||{};var tags=config.tags||[];for(const i in tags){var tag=tags[i],tagProps=themeOptions[tag];if(!$.isPlainObject(tagProps)){continue}
var fontFamily=tagProps['font-family'];if($ush.isUndefined(fontFamily)){continue}
if($ush.isUndefined(googleFonts[fontFamily])){continue}
var _fontFamily=$ush.rawurlencode(fontFamily);if(fontFamily!=='inherit'&&$ush.isUndefined(usedFonts[_fontFamily])){usedFonts[_fontFamily]=$ush.toString(googleFonts[fontFamily]).split(',')}}
for(const googleFont in additionalGoogleFonts){var _fontFamily=$ush.rawurlencode(googleFont);if($ush.isUndefined(usedFonts[_fontFamily])){usedFonts[_fontFamily]=additionalGoogleFonts[googleFont].split(',')}}
var inlineFonts=[];for(const fontFamily in usedFonts){var font=fontFamily,weights=usedFonts[fontFamily];if(weights.length){font+=':'+weights.join(',')}
inlineFonts.push(font);}
if(inlineFonts.length){return config.googleapis+'?family='+inlineFonts.join('|')+'&display='+config.font_display}
return ''}});$usb.fonts=new Fonts}(jQuery);!function($,_undefined){const _window=window;const _document=document;const abs=Math.abs;const ceil=Math.ceil;_window.$ush=_window.$ush||{};_window.usGlobalData=_window.usGlobalData||{};DIRECTION_TOP='top';DIRECTION_BOTTOM='bottom';const USBID_ALIAS_REGEXP=/^([\w\-]+:\d+)\|([a-z\d\-]+)$/;const SPACE_REGEXP=/\p{Zs}/u;const USBID_ATTR_REGEXP=/(\s?usbid="([^\"]+)?")/g;var _$mode='preview';const _defaultPageData={content:'',customCss:'',fields:{},postMeta:{}};const _$tmp={usedElementIds:[],isInitDragDrop:!1,isProcessSave:!1,savedPageData:$ush.clone(_defaultPageData),transit:null,customTransit:null,movedElements:{},};const elementsMap=new Map;function Builder(container){const self=this;self.mainContainer='container';self.selectedElmId;self._isReloadPreviewAfterSave=!1;self.pageData=$ush.clone(_defaultPageData);_window.onbeforeunload=(e)=>{if(self.isPageChanged()){e.preventDefault();return $usb.getTextTranslation('page_leave_warning')}};self._events={dragstart:self._dragstart.bind(self),iframeReady:self._iframeReady.bind(self),maybeDrag:self._maybeDrag.bind(self),maybeStartDrag:self._maybeStartDrag.bind(self),modeChanged:self._modeChanged.bind(self),historyChanged:self.historyChanged.bind(self),elmCopy:self._elmCopy.bind(self),elmDelete:self._elmDelete.bind(self),elmDuplicate:self._elmDuplicate.bind(self),elmPaste:self._elmPaste.bind(self),elmSelected:self._elmSelected.bind(self),endDrag:self._endDrag.bind(self),};$(()=>{self.$container=$(container);$usb.$document.on('dragstart',self._events.dragstart);_$tmp.customTransit=document.querySelector('.usb-custom-transit')});$usb.on('iframeReady',self._events.iframeReady).on('builder.modeChanged',self._events.modeChanged).on('builder.endDrag',self._events.endDrag).on('builder.elmCopy',self._events.elmCopy).on('builder.elmPaste',self._events.elmPaste).on('builder.elmDelete',self._events.elmDelete).on('builder.elmDuplicate',self._events.elmDuplicate).on('builder.elmSelected',self._events.elmSelected).on('history.changed',self._events.historyChanged)};const prototype=Builder.prototype;$.extend(prototype,$ush.mixinEvents,{_modeChanged:function(){$usb.postMessage('doAction','hideHighlight')},_iframeReady:function(){const self=this;if(!$usb.iframeIsReady){return}
const iframeWindow=$usb.iframe.contentWindow;if((iframeWindow.location.search||'').indexOf('&meta')!==-1){return}
$usb.postMessage('doAction','hideHighlight');self.pageData=$ush.clone((iframeWindow.usGlobalData||{}).pageData||{},_defaultPageData);_$tmp.savedPageData=$ush.clone(self.pageData);$ush.timeout(self.reloadElementsMap.bind(self),0)},_elmSelected:function(id){const self=this;if(!self.isMode('editor')||!self.doesElmExist(id)){return}
$usb.navigator.setActive(id,!0);if(self.selectedElmId===id){return}
if(self.doesElmExist(id)){if($usb.find('panel')){self.one('panel.afterInitFieldset',()=>{$usb.panel.resetBodyScroll()});$usb.builderPanel.initElmFieldset(id)}}else{$usb.postMessage('doAction','hideHighlight')}},_elmDuplicate:function(id){const self=this;if(!self.isValidId(id)){return}
var parentId=self.getElmParentId(id),strShortcode=self.getElmShortcode(id)||'',newElmId;strShortcode=strShortcode.replace(/(\s?el_id="([^\"]+)")/gi,'').replace(/usbid="([^\"]+)"/gi,(_,elmId)=>{elmId=self.getSpareElmId(elmId);if(!newElmId){newElmId=elmId}
return `usbid="${elmId}"`});if(!strShortcode||!newElmId){return}
const siblingsIds=self.getElmSiblingsId(id)||[];var index=0;for(;index<siblingsIds.length;index++){if(siblingsIds[index]===id){index++;break}}
if(!self.insertShortcodeIntoContent(parentId,index,strShortcode)){return}
self.reloadElementsMap();if(self.isReloadElm(parentId)){self.reloadElmInPreview(parentId);$usb.history.commitChange(newElmId,ACTION_CONTENT.CREATE)}else if(self.isReloadParentElm(newElmId)){self.reloadElmInPreview(self.getElmParentId(newElmId));$usb.history.commitChange(newElmId,ACTION_CONTENT.CREATE)}else{self.addElmToPreview(newElmId,index,parentId,_undefined,newElmId)}
$ush.timeout(self.reloadElementsMap.bind(self),0)},_elmCopy:function(id){const self=this;if(!self.isValidId(id)){return}
const content=$ush.toString(self.getElmShortcode(id));$ush.copyTextToClipboard(content.replace(/\susbid="([^\"]+)"/gi,''));$ush.storage('usb').set('сlipboard',content)},_elmPaste:function(id){const self=this;if(!self.isValidId(id)){return}
var content=$ush.toString($ush.storage('usb').get('сlipboard'));if(!content){$usb.notify.add($usb.getTextTranslation('empty_clipboard'),NOTIFY_TYPE.INFO);return}
var newElmId;content=content.replace(/(\s?el_id="([^\"]+)")/gi,'').replace(/usbid="([^\"]+)"/gi,(_,elmId)=>{elmId=self.getSpareElmId(elmId);if(!newElmId){newElmId=elmId}
return `usbid="${elmId}"`});const strictMode=(self.isElmTTA(id)||self.isChildElmContainer(id));var parentId=id
if((self.isRow(newElmId)&&self.isRow(id))||(self.isRowInner(newElmId)&&self.isRowInner(id))||(self.isElmSection(newElmId)&&self.isElmSection(id))){parentId=self.getElmParentId(id)}
if(!self.canBeChildOf(newElmId,parentId,strictMode)&&!(self.isElmSection(newElmId)&&self.isElmTTA(parentId))){$usb.notify.add($usb.getTextTranslation('cannot_paste'),NOTIFY_TYPE.INFO);return}
var index=0;if(parentId!==id){index=$ush.parseInt(self.getElmIndex(id))+1}else if(self.isElmTTA(parentId)){index=self.getElmChildren(parentId).length+1}
if(!self.insertShortcodeIntoContent(parentId,index,content)){$usb.notify.add($usb.getTextTranslation('invalid_data'),NOTIFY_TYPE.ERROR);return}
self.reloadElementsMap();if(self.isReloadElm(parentId)){self.reloadElmInPreview(parentId);$usb.history.commitChange(newElmId,ACTION_CONTENT.CREATE)}else if(self.isReloadParentElm(newElmId)){self.reloadElmInPreview(self.getElmParentId(newElmId));$usb.history.commitChange(newElmId,ACTION_CONTENT.CREATE)}else{self.addElmToPreview(newElmId,index,parentId)}
$ush.timeout(self.reloadElementsMap.bind(self),1)},_elmDelete:function(id){const self=this;if(!self.isValidId(id)){return}
if(self.isChildElmContainer(id)&&self.getElmSiblingsId(id).length===1){id=self.getElmParentId(id)}
self.removeElm(id)},historyChanged:function(task){const self=this;if($.isPlainObject(task)&&task.type===HISTORY_TYPE.REDO){elementsMap.set(task.id,{parentId:task.parentId,elmIndex:task.index})}},});$.extend(prototype,{_dragStartDistance:5,_dragstart:function(e){return $(e.target).closest('.media-frame').length>0},initDragDrop:function(){const self=this;if(_$tmp.isInitDragDrop){return}
_$tmp.isInitDragDrop=!0;$usb.$document.on('mousedown',self._events.maybeStartDrag).on('mousemove',self._events.maybeDrag).on('mouseup',self._events.endDrag);$usbcore.cache('drag').set({startX:0,startY:0})},destroyDragDrop:function(){const self=this;if(!_$tmp.isInitDragDrop){return}
_$tmp.isInitDragDrop=!1;$usb.$document.off('mousedown',self._events.maybeStartDrag).off('mousemove',self._events.maybeDrag).off('mouseup',self._events.endDrag);$usbcore.cache('drag').flush()},getNewElmId:function(){return $usbcore.cache('drag').get('newElmId','')},_getEventData:function(e){const self=this;if(!$usb.iframeIsReady){return}
const rect=$ush.$rect($usb.iframe);const iframeWindow=$usb.iframe.contentWindow;const data={clientX:e.clientX,clientY:e.clientY,eventX:e.pageX-rect.x,eventY:e.pageY-rect.y,pageX:(e.pageX+iframeWindow.scrollX)-rect.x,pageY:(e.pageY+iframeWindow.scrollY)-rect.y,};for(const prop in data){const value=data[prop]||NaN;if(isNaN(value)||value<0){data[prop]=0}else{data[prop]=ceil(data[prop])}}
return data},isParentDragging:function(){return!!_$tmp.isParentDragging},showTransit:function(type){const self=this;if(!type){return}
if(self.hasTransit()){self.hideTransit()}
if(self.isValidId(type)){type=self.getElmType(type)}
var target=_document.querySelector(`[data-type="${type}"]`);var isTemplate=$usb.templates.isTemplate(type),isFavoriteSection=$usb.favorites.isFavoriteSection(type);if(isTemplate){target=self.getCustomTransit('Template section')}else if(isFavoriteSection){target=self.getCustomTransit('Favorite section')}
if(!$ush.isNode(target)){return}
const transit={rect:$ush.$rect(target),scrollAcceleration:0,scrollDirection:_undefined,target:target.cloneNode(!0)};$usbcore.$removeClass(transit.target,'hidden');if(isTemplate||isFavoriteSection){self.hideCustomTransit()}['width','height'].map((prop)=>{var value=ceil(transit.rect[prop]);transit.target.style[prop]=value?value+'px':'auto'});$usbcore.$addClass(transit.target,'elm_transit').$addClass(transit.target,!self.isMode('drag:add')?'state_drag_move':'');_document.body.append(transit.target);_$tmp.transit=transit},hasTransit:function(){return!!_$tmp.transit},getCustomTransit:function(name){$usbcore.$removeClass(_$tmp.customTransit,'hidden');_$tmp.customTransit.querySelector('.for_name').innerText=$ush.toString(name);return _$tmp.customTransit},hideCustomTransit:function(){$usbcore.$addClass(_$tmp.customTransit,'hidden')},hasDragScrolling:function(){return[DIRECTION_TOP,DIRECTION_BOTTOM].includes((_$tmp.transit||{}).scrollDirection)},setTransitPosition:function(pageX,pageY){const self=this;if(!self.hasTransit()||!self.isMode('drag:add','drag:move')){return}
const transit=_$tmp.transit||{};if(!$ush.isNode(transit.target)){return}
var isDragAdd=self.isMode('drag:add'),transitHeight=transit.rect.height,transitTop=$ush.parseInt(isDragAdd?pageY-(transitHeight/2):pageY),transitLeft=$ush.parseInt(isDragAdd?pageX-(transit.rect.width/2):pageX);transit.target.style.top=transitTop.toFixed(3)+'px';transit.target.style.left=transitLeft.toFixed(3)+'px';if(!$usb.iframeIsReady){return}
var remainderToEnd=0,scrollDirection,viewportBottom=$ush.parseInt(_window.innerHeight-transitHeight);if(pageY<transitHeight){remainderToEnd=abs(pageY-transitHeight);scrollDirection=DIRECTION_TOP}else if(pageY>viewportBottom){remainderToEnd=abs(pageY-viewportBottom);scrollDirection=DIRECTION_BOTTOM}
const scrollAcceleration=ceil(abs(remainderToEnd/ /*acceleration step in px*/30));if(scrollDirection!==transit.scrollDirection||scrollAcceleration!==transit.scrollAcceleration){transit.scrollDirection=scrollDirection;transit.scrollAcceleration=scrollAcceleration;$usb.postMessage('doAction',['_scrollDragging',[scrollDirection,scrollAcceleration]])}},hideTransit:function(){const self=this;const transit=_$tmp.transit||{};if(!self.hasTransit()||!$ush.isNode(transit.target)){return}
self.stopDragScrolling();$usbcore.$remove(transit.target);delete _$tmp.transit},_maybeStartDrag:function(e){const self=this;if(!$usb.iframeIsReady||!e.target||e.target.className.includes('usb_skip_draggable')){return}
var found,iteration=0,target=e.target;while(!(found=!!$usbcore.$attr(target,'data-type'))&&iteration++<100){if(!target.parentNode){found=!1;break}
target=target.parentNode}
if(found){$usbcore.cache('drag').set({startDrag:!0,startX:e.pageX||0,startY:e.pageY||0,target:target,})}},_maybeDrag:function(e){const self=this;const dragData=$usbcore.cache('drag').data();if(!dragData.startDrag||!dragData.target){return}
const diffX=abs(dragData.startX-e.pageX);const diffY=abs(dragData.startY-e.pageY);if(diffX>self._dragStartDistance||diffY>self._dragStartDistance){if(self.isMode('editor')){$usbcore.cache('dragProcessData').flush();_$tmp.isParentDragging=!0;self.setMode('drag:add');var tempTargetType=$usbcore.$attr(dragData.target,'data-type');dragData.newElmId=self.getSpareElmId(tempTargetType);self.showTransit(tempTargetType,e.pageX,e.pageY);$usbcore.$addClass(dragData.target,'elm_add_shadow').$addClass(_document.body,'elm_add_draging')}
if(($ush.isFirefox||$ush.safariVersion()>=17)&&self.isParentDragging()){var eventData=self._getEventData(e);if(eventData.pageX){$usb.postMessage('onParentEventData',['_maybeDrop',eventData])}}
self.setTransitPosition(e.pageX,e.pageY)}},_endDrag:function(e){const self=this;if(!$usb.iframeIsReady){return}
const dragData=$usbcore.cache('drag').data();if($ush.isNode(dragData.target)){$usbcore.$removeClass(dragData.target,'elm_add_shadow').$removeClass(_document.body,'elm_add_draging')}
if($usb.panel.isShow()&&$ush.isFirefox&&$usb.preview.getCurrentOffset().x>=e.clientX){self._clearDragAssets();return}
if(!self.isParentDragging()){$usbcore.cache('drag').flush();return}
if(!!dragData.parentId&&!!dragData.currentId){var currentIndex=$ush.parseInt(dragData.currentIndex);if(self.isAliasElmId(dragData.parentId)){dragData.parentId=self.removeAliasFromId(dragData.parentId)}
var templateId=$usbcore.$attr(dragData.target,'data-template-id'),favoriteSectionId=$usbcore.$attr(dragData.target,'data-section-id');if(templateId){var templateCategoryId=$(dragData.target).closest('.usb-template').data('template-category-id');$usb.templates.insertTemplate(templateCategoryId,templateId,dragData.parentId,currentIndex)}else if(favoriteSectionId){$usb.favorites.insertSection(favoriteSectionId,dragData.parentId,currentIndex)}else{self.createElm(self.getElmType(dragData.currentId),dragData.parentId,currentIndex)}
if(self.isElmSection(dragData.parentId)){$usb.postMessage('doAction',['openSectionById',dragData.parentId])}}
if($ush.isFirefox||$ush.safariVersion()>=17){$usb.postMessage('onParentEventData','_endDrag')}
self._clearDragAssets()},_clearDragAssets:function(){const self=this;self.hideTransit();_$tmp.isParentDragging=!1;$usbcore.cache('drag').flush();self.setMode('editor');$usb.postMessage('doAction','clearDragAssets')},removeDragScrollData:function(){delete(_$tmp.transit||{}).scrollDirection},stopDragScrolling:function(){const self=this;if(!self.hasDragScrolling||!self.hasDragScrolling()){return}
self.removeDragScrollData();$usb.postMessage('doAction','_scrollDragging')},removeMovedElement:function(elmId){const self=this;if(elementsMap.has(elmId)){_$tmp.movedElements[elmId]=elementsMap.get(elmId);elementsMap.delete(elmId)}},restoreMovedElements:function(){if(this.hasMovedElements()){for(const elmId in _$tmp.movedElements){elementsMap.set(elmId,_$tmp.movedElements[elmId])}
_$tmp.movedElements={}}},hasMovedElements:function(){return!$.isEmptyObject(_$tmp.movedElements)},});$.extend(prototype,{reloadElementsMap:function(){const self=this;const content=$ush.toString(self.pageData.content);const allShortcodesRegexp=self.getShortcodeRegex('[\\dA-z_-]+');elementsMap.clear();const parseShortcode=(content,parentId,depth)=>{depth=$ush.parseInt(depth);if(!content||depth>1000){return}
Array.from(content.matchAll(allShortcodesRegexp)).forEach((matches,index)=>{const elmId=(matches[3].match(/(\s?usbid="([^\"]+)?")/)||[])[2];const shortcodeContent=$ush.toString(matches[5]);if(!elmId){return}
if(shortcodeContent){parseShortcode(shortcodeContent,elmId,depth++)}
elementsMap.set(elmId,{parentId:parentId,elmIndex:index})})}
parseShortcode(content,self.mainContainer)},isProcessSave:function(){return _$tmp.isProcessSave},savePageData:function(complete){const self=this;var data={postMeta:{},};if(self.isContentChanged()){data.post_content=self.pageData.content}
if(self.isPageFieldsChanged()){for(const prop in self.pageData.fields){data[prop]=self.pageData.fields[prop]}}
if(self.isPostMetaChanged()){for(const prop in self.pageData.postMeta){data.postMeta[prop]=self.pageData.postMeta[prop]}}
if(self.isPageCustomCssChanged()){data.postMeta[$usb.config('keyCustomCss','')]=self.pageData.customCss}
_$tmp.isProcessSave=!0;$usb.ajax('_savePageData',{data:$.extend(data,{_nonce:$usb.config('_nonce'),action:$usb.config('action_save_post'),}),success:(res)=>{if(!res.success){return}
$usb.notify.add($usb.getTextTranslation('page_updated'),NOTIFY_TYPE.SUCCESS);if(self._isReloadPreviewAfterSave&&(self.isPageFieldsChanged()||self.isPostMetaChanged())){self._isReloadPreviewAfterSave=!1;$usb.reloadPreview()}
_$tmp.savedPageData=$ush.clone(self.pageData)},complete:()=>{if(typeof complete==='function'){complete()}
_$tmp.isProcessSave=!1}})},isContentChanged:function(){return(_$tmp.savedPageData.content||'')!==(this.pageData.content||'')},isPageCustomCssChanged:function(){return(_$tmp.savedPageData.customCss||'')!==(this.pageData.customCss||'')},isPageFieldsChanged:function(){return!$ush.comparePlainObject(_$tmp.savedPageData.fields,this.pageData.fields)},isPostMetaChanged:function(){return!$ush.comparePlainObject(_$tmp.savedPageData.postMeta,this.pageData.postMeta)},isPageChanged:function(){const self=this;return(self.isContentChanged()||self.isPostMetaChanged()||self.isPageFieldsChanged()||self.isPageCustomCssChanged())},isEmptyContent:function(){return String(this.pageData.content).indexOf('[vc_row')===-1},isResponsiveObject:function(value){if(!$.isPlainObject(value)){return!1}
const states=$usb.config('responsiveStates',[]);for(const i in states)if(value.hasOwnProperty(states[i])){return!0}
return!1},modeIsValid:function(mode){const modes=['unknown','editor','preview','drag:add','drag:move',];return mode&&modes.includes(mode)},isMode:function(){const self=this;const args=arguments;for(const i in args)if(self.modeIsValid(args[i])&&_$mode===args[i]){return!0}
return!1},setMode:function(mode){const self=this;if(mode&&self.modeIsValid(mode)&&mode!==_$mode){$usb.trigger('builder.modeChanged',_$mode=mode);return!0}
return!1},getShortcodeRegex:function(tag){return new RegExp('\\[(\\[?)('+tag+')(?![\\w-])([^\\]\\/]*(?:\\/(?!\\])[^\\]\\/]*)*?)(?:(\\/)\\]|\\](?:([^\\[]*(?:\\[(?!\\/\\2\\])[^\\[]*)*)(\\[\\/\\2\\]))?)(\\]?)','g')},removeHtmlWrap:function(content){return $ush.toString(content).replace(/^<[^\[]+|[^\]]+$/gi,'')},parseShortcode:function(content){const self=this;content=self.removeHtmlWrap(content);if(!content){return{}}
const firstTag=(content.match(/^.*?\[([\w\-]+)\s/)||[])[1]||'';const matches=(self.getShortcodeRegex(firstTag)).exec(content);if(matches){return{tag:matches[2],atts:self._unescapeAttr(matches[3]||''),input:matches[0],content:matches[5]||'',hasClosingTag:!!matches[6]}}
return{}},parseAtts:function(str){const result={};if(!str){return result}
str=str.replace(/[\u00a0\u200b]/g,' ');(str.match(/[\w-_]+="([^\"]+)?"/g)||[]).forEach((attribute)=>{attribute=attribute.match(/([\w-_]+)="([^\"]+)?"/);if(!attribute){return}
const value=$ush.toString(attribute[2]).replace(/``/g,'"').replace(/`{`/g,'[').replace(/`}`/g,']');result[attribute[1]]=value.trim()});return result},buildShortcode:function(shortcode,attsDefaults){const self=this;if($.isEmptyObject(shortcode)){return ''}
var result='['+shortcode.tag;if(shortcode.atts||attsDefaults){if(!$.isEmptyObject(attsDefaults)){shortcode.atts=self.buildAtts(self.parseAtts(shortcode.atts),attsDefaults)}
shortcode.atts=self._escapeAttr(shortcode.atts);result+=' '+shortcode.atts.trim()}
result+=']';if(shortcode.content){result+=shortcode.content}
if(shortcode.hasClosingTag){result+='[/'+shortcode.tag+']'}
return ''+result},buildAtts:function(atts,defaults){if(!atts||$.isEmptyObject(atts)){return ''}
if($.isEmptyObject(defaults)){defaults={}}
const result=[];for(const k in atts){var value=atts[k];if(value===null||$ush.isUndefined(value)||(!$ush.isUndefined(defaults[k])&&defaults[k]===value)){continue}
if($.isPlainObject(value)){var inlineValue=[];for(var i in value){if(value[i]){inlineValue.push(i+':'+value[i])}}
value=inlineValue.join('|')}
value=$ush.toString(value).replace(/\"/g,'``').replace(/\[/g,'`{`').replace(/\]/g,'`}`');result.push(k+'="'+value+'"')}
return result.join(' ')},isValidId:function(id){return id&&/^([\w\-]+):(\d+)(\|[a-z\-]+)?$/.test(id)},isRow:function(id){return this.getElmName(id)==='vc_row'},isRowInner:function(id){return this.getElmName(id)==='vc_row_inner'},isColumn:function(id){return/^vc_column(_inner)?$/.test(this.getElmName(id))},isOutsideMainContainer:function(id){return $usb.config('elms_outside_main_container',[]).includes(this.getElmName(id))},isMainContainer:function(id){return id&&id===this.mainContainer},isElmContainer:function(name){const self=this;if(self.isValidId(name)){name=self.getElmName(name)}
return $usb.config('shortcode.containers',[]).includes(name)},isRootElmContainer:function(name){const self=this;if(self.isValidId(name)){name=self.getElmName(name)}
return(self.isElmContainer(name)&&!!$usb.config(`shortcode.relations.as_parent.${name}.only`))},isChildElmContainer:function(name){const self=this;if(self.isValidId(name)){name=self.getElmName(name)}
return(self.isElmContainer(name)&&!self.isRootElmContainer(name)&&!!$usb.config(`shortcode.relations.as_child.${name}.only`))},isReloadElm:function(elmId){const self=this;if($ush.isNode(elmId)){elmId=self.getElmId(elmId)}
if(!self.isValidId(elmId)){return!1}
return $usb.config('shortcode.reload_element',[]).includes(self.getElmName(elmId))},isReloadParentElm:function(elmId){const self=this;if($ush.isNode(elmId)){elmId=self.getElmId(elmId)}
if(!self.isValidId(elmId)){return!1}
return $usb.config('shortcode.reload_parent_element',[]).includes(self.getElmName(elmId))},isElmTTA:function(name){const self=this;if(self.isValidId(name)){name=self.getElmType(name)}
return/^vc_tta_(tabs|tour|accordion)$/.test(name)},isElmTab:function(name){const self=this;if(self.isValidId(name)){name=self.getElmType(name)}
return/^vc_tta_(tabs|tour)$/.test(name)},isElmSection:function(name){const self=this;if(self.isValidId(name)){name=self.getElmType(name)}
return name==='vc_tta_section'},_escapeAttr:function(value){return $ush.toString(value).replace(/\[/g,'&#91;').replace(/\]/g,'&#93;')},_unescapeAttr:function(value){return $ush.toString(value).replace(/&#91;/g,'[').replace(/&#93;/g,']')},canBeChildOf:function(id,parent,strict){const self=this;const args=arguments;const isMainContainer=self.isMainContainer(parent);if(self.isMainContainer(id)||!self.isValidId(id)||!(self.isValidId(parent)||isMainContainer)){return!1}
var targetName=self.getElmName(id),parentName=isMainContainer?parent:self.getElmName(parent),shortcodeRelations=$.extend({},$usb.config('shortcode.relations',{})),result=!0;if($.isEmptyObject(shortcodeRelations)){$usb.log('Notice: There are no relations and movement is allowed for every one',args);return!0}
return self._cacheDragProcessData(function(){for(var name in shortcodeRelations){if(!result){break}
var relations=shortcodeRelations[name][name==='as_child'?targetName:parentName];if(!$ush.isUndefined(relations)){for(var condition in relations){if(self.isMode('drag:add')&&parentName===self.mainContainer&&!self.isChildElmContainer(id)){continue}
if(!result){break}
var allowed=(relations[condition]||'').split(','),isFound=allowed.indexOf(name==='as_child'?parentName:targetName)!==-1;if((condition==='only'&&!isFound)||(condition==='except'&&isFound)){result=!1}}}}
if(result&&!!strict&&(isMainContainer||self.isChildElmContainer(id))){const hasMovedElements=(self.isMode('drag:move')&&self.hasMovedElements());var movedElementsBackup;if(hasMovedElements){movedElementsBackup=$ush.clone(_$tmp.movedElements);self.restoreMovedElements()}
const elmParentId=self.getElmParentId(id);if(hasMovedElements&&movedElementsBackup){_$tmp.movedElements=$ush.clone(movedElementsBackup);for(const elmId in movedElementsBackup){self.removeMovedElement(elmId)}
movedElementsBackup=null}
return parent===elmParentId}
return result},'canBeChildOf:'+$ush.toArray(args).join('|'),!1)},hasSameTypeParent:function(type,parent){const self=this;if(self.isMainContainer(type)||self.isMainContainer(parent)||!self.isValidId(parent)){return!1}
if(self.isValidId(type)){type=self.getElmType(type)}
if(type===self.getElmType(parent)){return!0}
var iteration=0;while(parent!==null||self.isMainContainer(parent)){if(iteration++>=1000){break}
parent=self.getElmParentId(parent);if(self.getElmType(parent)===type){return!0}}
return!1},getValidContainerId:function(container){return this.isElmContainer(container)?container:this.mainContainer},isAliasElmId:function(id){const self=this;if(!self.isValidId(id)){return!1}
return USBID_ALIAS_REGEXP.test(id)},getAliasFromId:function(id){const self=this;if(!self.isValidId(id)){return null}
return(id.match(USBID_ALIAS_REGEXP)||[])[2]||null},addAliasToElmId:function(alias,id){const self=this;const args=arguments;if(alias&&typeof alias==='string'&&self.isValidId(id)){id+='|'+alias}else{$usb.log('Notice: Failed to add alias to id',args)}
return id},removeAliasFromId:function(id){const self=this;if(!self.isValidId(id)){return id}
return(id.match(USBID_ALIAS_REGEXP)||[])[1]||id},getElmType:function(id){const self=this;if($ush.isNode(id)){id=self.getElmId(id)}
return self.isValidId(id)?id.split(':')[0]||'':''},getElmName:function(id){const type=this.getElmType(id);return(type.match(/us_(.*)/)||[])[1]||type},getElmTitle:function(id){const self=this;if(!self.isValidId(id)){return 'Unknown'}
const name=self.getElmName(id);return $usb.config(`elm_titles.${name}`)||name},doesElmExist:function(id){const self=this;if(!self.isValidId(id)||elementsMap.size===0){return!1}
return elementsMap.has(id)},getElmId:function(node){const self=this;if(!$ush.isNode(node)){return ''}
if(!node.hasOwnProperty('_$$usbid')){const id=$usbcore.$attr(node,'data-usbid');node._$$usbid=(self.isValidId(id)||self.isMainContainer(id))?id:''}
return node._$$usbid},getElmIndex:function(id){const self=this;if(!self.isValidId(id)){return null}
const index=(self.getElmSiblingsId(id)||[]).indexOf(id);return index>-1?index:null},getSpareElmId:function(type){const self=this;if(!type){return ''}
if(self.isValidId(type)){type=self.getElmType(type)}
if(!Array.isArray(_$tmp.usedElementIds)){_$tmp.usedElementIds=[]}
for(var index=1;;index++){const newElementId=type+':'+index;if(!self.doesElmExist(newElementId)&&!_$tmp.usedElementIds.includes(newElementId)){_$tmp.usedElementIds.push(newElementId);return newElementId}}},getElmParentId:function(id){const self=this;if(!self.doesElmExist(id)||id===self.mainContainer){return null}
if(elementsMap.has(id)){return elementsMap.get(id).parentId||null}
return null},getElmSiblingsId:function(id){const self=this;if(!self.isValidId(id)||self.isMainContainer(id)){return[]}
return self.getElmChildren(self.getElmParentId(id))},getElmChildren:function(id){const self=this;const result=[];if(id){elementsMap.forEach((elmData,elmId)=>{if(elmData.parentId===id){result[elmData.elmIndex]=elmId}})}
return result.filter((val)=>{return val})},getElmAllChildren:function(id){const self=this;if(!self.isValidId(id)||!self.isElmContainer(id)){return[]}
const args=$ush.toArray(arguments);const childrenIDs=self.getElmChildren(id);var depth=$ush.parseInt(args[1]),result=[];for(const i in childrenIDs){const childrenId=childrenIDs[i];if(!self.isValidId(childrenId)){continue}
result.push(childrenId);if(self.isElmContainer(childrenId)){if(depth>=20){$usb.log('Notice: Exceeded number of levels in recursion:',args)}else{result=result.concat(self.getElmAllChildren(childrenId,depth++))}}}
return result},getElmShortcode:function(id){const self=this;const content=$ush.toString(self.pageData.content);if($ush.isUndefined(id)){return content}
if(!self.isValidId(id)){return ''}
const matches=content.match(self.getShortcodeRegex(self.getElmType(id)));if(matches){for(const i in matches){if(matches[i].indexOf(`usbid="${id}"`)!==-1){return matches[i]}}}
return ''},getElmNode:function(id){const self=this;if(!$usb.iframeIsReady){return null}
return($usb.iframe.contentWindow.$usbp||{}).getElmNode(id)},getElmOuterHtml:function(id){const self=this;if(!$usb.iframeIsReady){return ''}
return($usb.iframe.contentWindow.$usbp||{}).getElmOuterHtml(id)||''},getElmValues:function(id){const self=this;if(!self.doesElmExist(id)){return{}}
const shortcode=self.parseShortcode(self.getElmShortcode(id));if(!$.isEmptyObject(shortcode)){var result=self.parseAtts(shortcode.atts),elmName=self.getElmName(id);var editContent=$usb.config('shortcode.edit_content',{});if(!!editContent[elmName]){result[editContent[elmName]]=''+shortcode.content}
return result}
return{}},getElmValue:function(id,key,defaultValue){return this.getElmValues(id)[key]||defaultValue},setElmValues:function(id,values){const self=this;if(!self.doesElmExist(id)||$.isEmptyObject(values)){return}
const shortcode=self.getElmShortcode(id);const shortcodeObj=self.parseShortcode(shortcode);if($.isEmptyObject(shortcodeObj)){return}
shortcodeObj.atts=' '+self.buildAtts($.extend(self.getElmValues(id),values));self.pageData.content=$ush.toString(self.pageData.content).replace(shortcode,self.buildShortcode(shortcodeObj));$usb.trigger('builder.contentChange')},_cacheDragProcessData:function(callback,key,defaultValue){const self=this;if(typeof callback!=='function'){return defaultValue}
if(self.isMode('drag:add','drag:move')){return $usbcore.cache('dragProcessData').get(key,callback)}
return callback.call(self)},renderShortcode:function(requestId,settings){const self=this;if(!requestId||$.isEmptyObject(settings)){return}
if(!$.isPlainObject(settings.data)){settings.data={}}
$.extend(settings.data,{_nonce:$usb.config('_nonce'),action:$usb.config('action_render_shortcode')});if($ush.isUndefined(settings.data.content)){settings.data.content=''}else{settings.data.content+=''}
$usb.ajax(requestId,settings)},_updateColumnsLayout:function(rowId,layout){const self=this;if('custom'===layout){return}
var columns=self.getElmChildren(rowId),columnsCount=columns.length,renderNeeded=!1,columnType=self.isRow(rowId)?'vc_column':'vc_column_inner',newColumnsWidths=[],newColumnsWidthsBase=0,newColumnsWidthsTmp,newColumnsCount;layout=''+layout;if(layout.indexOf('-')>-1){newColumnsWidthsTmp=layout.split('-');newColumnsCount=newColumnsWidthsTmp.length;for(var i=0;i<newColumnsCount;i ++){newColumnsWidthsBase+=$ush.parseInt(newColumnsWidthsTmp[i])}
for(var i=0;i<newColumnsCount;i ++){var columnWidthBaseTmp=newColumnsWidthsBase/newColumnsWidthsTmp[i];if(columnWidthBaseTmp%1===0){newColumnsWidths.push('1/'+columnWidthBaseTmp)}else{newColumnsWidths.push(newColumnsWidthsTmp[i]+'/'+newColumnsWidthsBase)}}}else if(layout.indexOf('(')===-1&&layout.indexOf('fr')>-1){var customColumns=layout.trim().split(SPACE_REGEXP);newColumnsCount=0;for(var i in customColumns){var columnName=customColumns[i];if(columnName.indexOf('fr')>-1){newColumnsWidths.push('1/1');newColumnsCount++}}}else{newColumnsCount=$ush.parseInt(layout);if(newColumnsCount>10){newColumnsCount=10}
for(var i=0;i<newColumnsCount;i ++){newColumnsWidths.push('1/'+layout)}}
if(columnsCount<newColumnsCount){for(var i=columnsCount;i<newColumnsCount;i ++){const newColumnId=self.getSpareElmId(columnType);self.insertShortcodeIntoContent(rowId,i,`[${columnType} usbid="${newColumnId}"][/${columnType}]`);elementsMap.set(newColumnId,{parentId:rowId,elmIndex:i})}
columnsCount=newColumnsCount;renderNeeded=!0}else if(columnsCount>newColumnsCount){var columnsCountDifference=columnsCount-newColumnsCount;for(var i=columnsCount-1;(i>=0)&&(columnsCountDifference>0);i --){var columnChildren=self.getElmChildren(columns[i]);if(columnChildren.length===0){self.removeElm(columns[i]);columnsCountDifference--}}
columnsCount=newColumnsCount+columnsCountDifference}
columns=self.getElmChildren(rowId);$usb.trigger('builder.contentChange');for(var i=0;i<columnsCount;i ++){self.setElmValues(columns[i],{width:newColumnsWidths[i%newColumnsWidths.length]})}
return renderNeeded},getInsertPosition:function(parent,index){const self=this;const isParentContainer=self.isElmContainer(parent);var position;index=$ush.parseInt(index);if(self.isMainContainer(parent)||isParentContainer){const children=self.getElmChildren(parent);if(index===0||children.length===0){position='prepend'}else if(index>children.length||children.length===1){index=children.length;position='append'}else{parent=children[index-1]||parent;position='after'}}else{position=(index<1?'before':'after')}
return{position:position,parent:parent}},insertShortcodeIntoContent:function(parent,index,newShortcode){const self=this;if(!newShortcode||!(self.isValidId(parent)||self.isMainContainer(parent))){return!1}
const insertPosition=self.getInsertPosition(parent,index);parent=insertPosition.parent;const isMainContainer=self.isMainContainer(parent);const elmType=!isMainContainer?self.getElmType(parent):'';const content=$ush.toString(self.pageData.content);var oldShortcode=!isMainContainer?self.getElmShortcode(parent):content;oldShortcode=self.removeHtmlWrap(oldShortcode);var position=insertPosition.position;if(isMainContainer){position=(position==='before'||position==='after')?'container:prepend':'container:'+position}
var insertShortcode='';if(position==='before'||position==='container:prepend'){insertShortcode=newShortcode+oldShortcode}else if(position==='prepend'){insertShortcode=oldShortcode.replace(new RegExp('^(\\['+elmType+'.*?[\\^\\]]+)'),(_,match)=>{return match+newShortcode})}else if(position==='append'&&self.parseShortcode(oldShortcode).hasClosingTag){insertShortcode=oldShortcode.replace(new RegExp('(\\[\\/'+elmType+'\])$'),(_,match)=>{return newShortcode+match})}else{insertShortcode=oldShortcode+newShortcode}
self.pageData.content=content.replace(oldShortcode,insertShortcode);return!0},_getDefaultContent:function(elmType){const self=this;const shortcodeConfig=$usb.config('shortcode',{});const _getDefaultContent=(type)=>{var defaultValues=(shortcodeConfig.default_values||{})[type]||!1,editContent=(shortcodeConfig.edit_content||{})[type]||!1;if(editContent&&defaultValues&&defaultValues[editContent]){return defaultValues[editContent]}
return ''};const child=$usb.config(`shortcode.relations.as_parent.${elmType}.only`);if(!child){return _getDefaultContent(elmType)}
if(self.isElmSection(child)){const titleTemplate=$usb.getTextTranslation('section'),params={title_1:(titleTemplate+' 1'),title_2:(titleTemplate+' 2'),vc_column_text:self.getSpareElmId('vc_column_text'),vc_column_text_content:_getDefaultContent('vc_column_text'),vc_tta_section_1:self.getSpareElmId(child),vc_tta_section_2:self.getSpareElmId(child)};return $usb.buildString($usb.config(`template.${child}`,''),params)}else{return '['+child+' usbid="'+self.getSpareElmId(child)+'"][/'+child+']'}},addElmToPreview:function(elmId,elmIndex,parentId,callback,newTargetId){const self=this;if(!self.isValidId(elmId)){return}
const insert=self.getInsertPosition(parentId,elmIndex);$usb.postMessage('showPreloader',[insert.parent,insert.position,self.isElmContainer(self.getElmType(elmId)),newTargetId]);self.renderShortcode(`addElmToPreview[${newTargetId}]`,{data:{content:self.getElmShortcode(elmId),},success:(res)=>{$usb.postMessage('hidePreloader',newTargetId||insert.parent);if(res.success){$usb.postMessage('insertElm',[insert.parent,insert.position,res.data.html]);$usb.postMessage('maybeInitElmJS',[elmId]);$usb.trigger('builder.contentChange');$usb.history.commitChange(elmId,ACTION_CONTENT.CREATE)}
if(typeof callback==='function'){callback.call(self,elmId)}}})},reloadElmInPreview:function(elmId,callback){const self=this;if(!self.isValidId(elmId)||self.isMainContainer(elmId)){return}
$usb.postMessage('showPreloader',elmId);self.renderShortcode('reloadElmInPreview',{data:{content:self.getElmShortcode(elmId),},success:(res)=>{$usb.postMessage('hidePreloader',elmId);$usb.postMessage('doAction',['removeHighlights',!0]);if(res.success){var html=$ush.toString(res.data.html).replace(/(us_animate_this)/g,"$1 start");$usb.postMessage('updateSelectedElm',[elmId,html])}
if(typeof callback==='function'){callback.call(self,elmId)}
$usb.trigger('builder.contentChange')}})},createElm:function(type,parentId,elmIndex,values,callback){const self=this;const args=arguments;const isMainContainer=self.isMainContainer(parentId);if(!type||!parentId||!(self.isValidId(parentId)||isMainContainer)){$usb.log('Error: Invalid params',args);return}
if(self.hasSameTypeParent(type,parentId)){$usb.log('Error: It is forbidden to add inside the same type',args);return}
$usb.postMessage('doAction','hideHighlight');elmIndex=$ush.parseInt(elmIndex);if(!isMainContainer&&!self.doesElmExist(parentId)){parentId=self.mainContainer;elmIndex=0}
var elmId=self.getSpareElmId(type),elmName=self.getElmName(elmId);if(!$.isPlainObject(values)){values={}}
var buildShortcode=self.buildShortcode({tag:type,atts:self.buildAtts($.extend({usbid:elmId},values)),content:self._getDefaultContent(elmName),hasClosingTag:(self.isElmContainer(elmName)||!!$usb.config(`shortcode.edit_content.${elmName}`))});if(self.isMainContainer(parentId)&&!self.isRow(elmId)&&!$usb.templates.isTemplate(type)){elmId=self.getSpareElmId('vc_row');buildShortcode=$usb.buildString($usb.config('template.vc_row',''),{vc_row:elmId,vc_column:self.getSpareElmId('vc_column'),content:buildShortcode})}
if(!self.insertShortcodeIntoContent(parentId,elmIndex,buildShortcode)){return!1}
if(self.isReloadElm(parentId)){self.reloadElmInPreview(parentId);$usb.history.commitChange(elmId,ACTION_CONTENT.CREATE)}else{self.addElmToPreview(elmId,elmIndex,parentId,callback)}
self.reloadElementsMap();return elmId},moveElm:function(moveId,newParentId,newIndex){const self=this;const args=arguments;if(self.isMainContainer(moveId)){$usb.log('Error: Cannot move the container',args);return!1}
const isMainContainer=self.isMainContainer(newParentId);if(self.hasSameTypeParent(moveId,newParentId)){$usb.log('Error: It is forbidden to add inside the same type',args);return}
if(!self.isValidId(moveId)||!(self.isValidId(newParentId)||isMainContainer)){$usb.log('Error: Invalid ID specified',args);return!1}
const oldParentId=self.getElmParentId(moveId);newIndex=$ush.parseInt(newIndex);$usb.postMessage('doAction','hideHighlight');if(!isMainContainer&&!self.doesElmExist(newParentId)){newParentId=self.mainContainer;newIndex=0}
$usb.history.commitChange(moveId,ACTION_CONTENT.MOVE);const oldShortcode=self.getElmShortcode(moveId);self.pageData.content=$ush.toString(self.pageData.content).replace(oldShortcode,'');const insert=self.getInsertPosition(newParentId,newIndex);if(!self.insertShortcodeIntoContent(newParentId,newIndex,oldShortcode)){return!1}
$usb.postMessage('moveElm',[insert.parent,insert.position,moveId]);if(self.isReloadElm(oldParentId)){self.reloadElmInPreview(oldParentId)}else if(self.isReloadElm(newParentId)){self.reloadElmInPreview(newParentId)}
self.reloadElementsMap();$usb.trigger('builder.contentChange');return!0},removeElm:function(removeId){const self=this;if(!self.isValidId(removeId)){return!1}
$usb.postMessage('removeHtmlById',removeId);const selectedElmId=self.selectedElmId;const rootContainerId=self.getElmParentId(removeId);var children=self.getElmAllChildren(removeId);$usb.history.commitChange(removeId,ACTION_CONTENT.REMOVE);self.pageData.content=$ush.toString(self.pageData.content).replace(self.getElmShortcode(removeId),'');$usb.trigger('builder.contentChange');if(self.isColumn(removeId)){$usb.postMessage('vcColumnChanged',rootContainerId)}
if(self.isReloadElm(rootContainerId)){self.reloadElmInPreview(rootContainerId)}
if(selectedElmId&&(removeId==selectedElmId||children.includes(selectedElmId))){$usb.trigger('panel.showAddElms')}
children.push(removeId);for(const k in children){elementsMap.delete(children[k])}
$usb.navigator.removeElm(removeId);return!0},updateIdsInContent:function(content,html){const self=this;var firstElmId,customPrefix=$usb.config('designOptions.customPrefix','usb_custom_');html=$ush.toString(html);content=$ush.toString(content);content=content.replace(USBID_ATTR_REGEXP,(match,input,elmId)=>{const newElmId=self.getSpareElmId(elmId);if(!firstElmId){firstElmId=newElmId}
if(html){html=html.replace(new RegExp(`data-(for|usbid)="${elmId}"`,'g'),`data-$1="${newElmId}"`).replace(new RegExp(customPrefix+elmId.replace(':',''),'g'),$ush.uniqid(customPrefix))}
return input.replace(elmId,newElmId)});return{firstElmId:firstElmId,content:content,html:html,}},});$usb.builder=new Builder('#usb-wrapper')}(jQuery);!function($,_undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};const USBID_ATTR_REGEXP=/(\s?usbid="([^\"]+)?")/g;var _$tmp={elmsFieldset:{},isFieldsetsLoaded:!1,};function BuilderPanel(){const self=this;self.activeElmFieldset;self.$activeElmFieldset;self._events={contentChange:self._contentChange.bind(self),iframeReady:self._iframeReady.bind(self),resetSearch:self._resetSearch.bind(self),saveChanges:self._saveChanges.bind(self),searchElms:self._searchElms.bind(self),showAddElms:self._showAddElms.bind(self),submitPreviewChanges:self._submitPreviewChanges.bind(self),switchPanel:self._switchPanel.bind(self),onSwitchTabs:self.$$fieldsets.onSwitchTabs.bind(self),urlManager:self._urlManager.bind(self),clearBody:self.clearBody.bind(self),changeImportContent:self._changeImportContent.bind(self),saveImportContent:self._saveImportContent.bind(self),showImportContent:self._showImportContent.bind(self),afterHideField:self._afterHideField.bind(self),changeDesignField:self._changeDesignField.bind(self),changeField:self._changeField.bind(self),dataIndicatorChanged:self.dataIndicatorChanged.bind(self),};$(()=>{self.$tabElements=$('.usb-panel-tab-elements',$usb.$panel);self.$elms=$('.usb-panel-elms',$usb.$panel);self.$searchElms=$('[data-search-text]',$usb.$panel);self.$searchField=$('input[name=search]',self.$elms);self.$searchNoResult=$('.usb-panel-search-noresult',self.$elms);self.$importContent=$('.usb-panel-import-content',$usb.$panel);self.$importTextarea=$('.usb-panel-import-content textarea:first',$usb.$panel);self.$actionSaveImportContent=$('.usb_action_save_import_content',$usb.$panel);self.$actionAddElms=$('.usb_action_show_add_elms',$usb.panel.$header);self.$actionTabAddElms=$('.usb_action_tab_add_elms',self.$tabElements);if($usb.panel.isShow()){$usb.builder.setMode('editor')}
$usb.$panel.on('click','.usof-tabs-item',self._events.onSwitchTabs).on('click','.usb_action_show_add_elms',self._events.showAddElms).on('click','.usb_action_tab_add_elms',self._events.showAddElms).on('submit','form#wp-preview',self._events.submitPreviewChanges).on('click','.usb_action_show_import_content',self._events.showImportContent).on('change input blur','.usb-panel-import-content textarea',self._events.changeImportContent).on('click','.usb_action_save_import_content',self._events.saveImportContent);self.$elms.on('input','input[name=search]',$ush.debounce(self._events.searchElms,1)).on('click','.usb_action_reset_search_in_panel',self._events.resetSearch);self._urlManager($usb.urlManager.getDataOfChange())});$usb.on('iframeReady',self._events.iframeReady).on('builder.contentChange',self._events.contentChange).on('panel.switch',self._events.switchPanel).on('panel.showAddElms',self._events.showAddElms).on('panel.clearBody',self._events.clearBody).on('panel.saveChanges',self._events.saveChanges).on('hotkeys.ctrl+s',self._events.saveChanges).on('urlManager.changed',self._events.urlManager)}
const prototype=BuilderPanel.prototype;$.extend(prototype,$ush.mixinEvents,{clearBody:function(){const self=this;self._hideImportContent();self._hideAddElms();self._destroyElmFieldset()},_switchPanel:function(){const isShow=$usb.panel.isShow();const selectedElmId=$usb.find('builder.selectedElmId');var doActionArgs='hideEditableHighlight';if(isShow&&selectedElmId){doActionArgs=['showEditableHighlight',selectedElmId]}
$usb.postMessage('doAction',doActionArgs);$usb.builder.setMode(isShow?'editor':'preview')},_searchElms:function(){const self=this;const $input=self.$searchField;const value=$ush.toLowerCase($input[0].value).trim();var isFoundResult=!0;$input.next('.usb_action_reset_search_in_panel').toggleClass('hidden',!value);self.$searchElms.toggleClass('hidden',!!value);if(value){isFoundResult=self.$searchElms.filter(`[data-search-text^="${value}"]:not(.deprecated), [data-search-text*="${value}"]:not(.deprecated)`).removeClass('hidden').length>0}
$('.usb-panel-elms-list',self.$elms).each((_,list)=>{const listIsEmpty=!$('[data-search-text]:not(.hidden)',list).length;$(list).toggleClass('hidden',listIsEmpty).prev('.usb-panel-elms-header').toggleClass('hidden',listIsEmpty)});self.$searchNoResult.toggleClass('hidden',isFoundResult)},_resetSearch:function(){const $input=this.$searchField;if($input.val()){$input.val('').trigger('input')}},_submitPreviewChanges:function(e){const self=this;$('textarea[name="post_content"]',e.target).val($usb.builder.pageData.content);$('textarea[name='+$usb.config('keyCustomCss','')+']',e.target).val($usb.builder.pageData.customCss)},_saveChanges:function(){const self=this;if($usb.urlManager.hasParam('active','site_settings')||!$usb.builder.isPageChanged()||$usb.builder.isProcessSave()){return}
$usb.panel.switchSaveButton(!0,!0);$usb.builder.savePageData(()=>{$usb.panel.switchSaveButton(!1)})},_contentChange:function(){$usb.panel.switchSaveButton($usb.builder.isPageChanged())},_showAddElms:function(){$usb.urlManager.removeParam('active').push();this.showAddElms()},showAddElms:function(){const self=this;const $actionAddElms=self.$actionAddElms;if(self.$tabElements.is(':visible')){return}
$usb.trigger('panel.clearBody');$usb.navigator.resetActive();$usb.panel.clearBody();$usb.postMessage('doAction','hideHighlight');$usb.builder.setMode('editor');$actionAddElms.addClass('active');$usb.builder.selectedElmId=null;$ush.timeout(()=>{self.$searchField[0].focus()},10);self.$tabElements.removeClass('hidden');if(!self.$actionTabAddElms.hasClass('active')){self.$actionTabAddElms.trigger('click')}
$usb.panel.setTitle($actionAddElms.attr('title'));$usb.builder.initDragDrop()},_hideAddElms:function(){const self=this;if(!$usb.panel.isReady()){return}
self.$actionAddElms.removeClass('active');self.$tabElements.addClass('hidden');$usb.builder.destroyDragDrop()},_urlManager:function(state){const self=this;const setParams=state.setParams;if(!$usb.panel.isReady()){return}
if(!setParams.active&&!$usb.find('builder.selectedElmId')&&setParams.action!=$usb.config('actions.site_settings')){self.showAddElms()}else if(setParams.active=='paste_row'){self.showImportContent()}}});$.extend(prototype,{showImportContent:function(){const self=this;self.clearBody();$usb.builder.setMode('editor');$usb.navigator.resetActive();$usb.panel.clearBody();self.$importContent.removeClass('hidden');self.$importTextarea.val('').removeClass('validate_error');self.$importTextarea[0].focus();self.$actionSaveImportContent.prop('disabled',!0).addClass('disabled');$usb.panel.setTitle('paste_row',!0);$usb.builder.selectedElmId=null},_showImportContent:function(){$usb.urlManager.setParam('active','paste_row').push()},_hideImportContent:function(){if($usb.panel.isReady()){this.$importContent.addClass('hidden')}},_changeImportContent:function(e){const self=this;$usb.notify.closeAll();var target=e.target,pastedContent=target.value.trim();if(pastedContent.indexOf('usbid=')!==-1){pastedContent=pastedContent.replace(USBID_ATTR_REGEXP,'')}
if(target.value!==pastedContent){target.value=pastedContent}
$(target).removeClass('validate_error');self.$actionSaveImportContent.prop('disabled',!pastedContent).toggleClass('disabled',!pastedContent)},_saveImportContent:function(){const self=this;var $textarea=self.$importTextarea,$saveButton=self.$actionSaveImportContent,pastedContent=$textarea.val()||'';if(!pastedContent){$saveButton.prop('disabled',!0).addClass('disabled');return}
pastedContent=$usb.builder.removeHtmlWrap(pastedContent);const isValid=!(!/^\[vc_row([\s\S]*)\/vc_row\]$/gim.test(pastedContent)||pastedContent.indexOf('[vc_column')===-1);$textarea.toggleClass('validate_error',!isValid);if(!isValid){$usb.notify.add($usb.getTextTranslation('invalid_data'),NOTIFY_TYPE.ERROR);return}
$textarea.prop('disabled',!0).addClass('disabled');$saveButton.addClass('loading disabled').prop('disabled',!0);var elmId;pastedContent=pastedContent.replace(/\[(\w+)/g,(match,tag,offset)=>{const id=$usb.builder.getSpareElmId(tag);if(0===offset){elmId=id}
return match+` usbid="${id}"`});var placeholder=$usb.config('placeholder','');pastedContent=pastedContent.replace(/use:placeholder/g,placeholder);pastedContent=pastedContent.replace(/css="([^\"]+)"/g,(matches,match)=>{if(match){var jsoncss=(decodeURIComponent(match)||'').replace(/("background-image":")(.*?)(")/g,(_,before,id,after)=>{return before+($ush.parseInt(id)||placeholder)+after});return 'css="%s"'.replace('%s',encodeURIComponent(jsoncss))}
return matches});pastedContent=pastedContent.replace(/\s?post_type="(.*?)"/g,(match,post_type)=>{if($usb.config('grid_post_types',[]).indexOf(post_type)===-1){return ' post_type="post"'}
return match});$usb.builder.renderShortcode('_renderPastedContent',{data:{content:pastedContent,isReturnContent:!0,},success:(res)=>{if(!res.success||!res.data.html){return}
$usb.history.commitChange(elmId,ACTION_CONTENT.CREATE);$usb.builder.pageData.content+=(res.data.content||pastedContent.replace(/(grid_layout_data="([^"]+)")/g,'items_layout=""'));$usb.builder.reloadElementsMap();$usb.postMessage('insertElm',[$usb.builder.mainContainer,'append',res.data.html,!0]);$usb.trigger('builder.contentChange')},complete:(_,textStatus)=>{const isSuccess=(textStatus==='success');$saveButton.prop('disabled',isSuccess).removeClass('loading').toggleClass('disabled',isSuccess);$textarea.prop('disabled',!1).removeClass('disabled');if(isSuccess){$textarea.val('')}}})}});$.extend(prototype,{_loadDeferredFieldsets:function(name){const self=this;const data={};$usb.$panel.addClass('data_loading');var requestId='loadDeferredFieldsets';if(!$ush.isUndefined(name)){data.name=name;requestId+='.name';$usb.$panel.addClass('show_preloader')}
$usb.ajax(requestId,{data:$.extend(data,{_nonce:$usb.config('_nonce'),action:$usb.config('action_get_deferred_fieldsets'),}),success:(res)=>{if(!res.success){return}
const fieldsets=$.isPlainObject(res.data)?res.data:{};for(const name in fieldsets){if(!!_$tmp.elmsFieldset[name]){continue}
_$tmp.elmsFieldset[name]=fieldsets[name];self.trigger('fieldsetLoaded',[name]);}
var removeClasses='data_loading';if(!data.name){_$tmp.isFieldsetsLoaded=!0;removeClasses+=' show_preloader'}else{removeClasses=' show_preloader'}
$usb.$panel.removeClass(removeClasses)}})},_iframeReady:function(){$ush.timeout(this._loadDeferredFieldsets.bind(this),100)},initElmFieldset:function(id,callback){const self=this;if(!$usb.builder.doesElmExist(id)){return}
$usb.panel.clearBody();$usb.urlManager.removeParam('active').push();var name=$usb.builder.getElmName(id),elmsSupported=$usb.config('elms_supported',[]),elmTitle=$usb.config(`elm_titles.${name}`,name);if(!Array.isArray(elmsSupported)||$usbcore.indexOf(name,elmsSupported)<0){$usb.builder.selectedElmId=id;$usb.panel.setTitle(elmTitle);$usb.panel.showMessage($usb.getTextTranslation('editing_not_supported'));$usb.navigator.setActive(id,!0);$usb.postMessage('doAction',['showEditableHighlight',id]);return}
if(!_$tmp.elmsFieldset[name]){$('#usb-tmpl-fieldsets .usb-panel-fieldset[data-name]',$usb.$panel).each((_,node)=>{_$tmp.elmsFieldset[$(node).data('name')]=node.outerHTML}).remove()}
if(!_$tmp.elmsFieldset[name]&&!_$tmp.isFieldsetsLoaded){$usb.panel.setTitle(elmTitle);self.off('fieldsetLoaded');self.one('fieldsetLoaded',(loadedName)=>{if(name!==loadedName){return}
self._showElmFieldset(id)});self._loadDeferredFieldsets(name);return}
self._showElmFieldset(id)},_showElmFieldset:function(id){const self=this;if(!$usb.builder.doesElmExist(id)){return}
const name=$usb.builder.getElmName(id);if(!name){return}
const values=$usb.builder.getElmValues(id)||{};const defaultValues=$usb.config(`shortcode.default_values.${name}`,{});if($.isPlainObject(defaultValues)){for(const k in defaultValues)if(k!=='content'){if($ush.isUndefined(values[k])){values[k]=defaultValues[k]}}}
if($usb.$panel.hasClass('show_preloader')){$usb.$panel.removeClass('show_preloader')}
$usb.trigger('panel.clearBody');if($usb.config('dynamicFieldsetAssets.codeEditor',[]).includes(name)){self._loadAssetsForCodeEditor()}
self.$activeElmFieldset=$(_$tmp.elmsFieldset[name]);$usb.$panelBody.prepend(self.$activeElmFieldset);$usb.builder.selectedElmId=id;self.activeElmFieldset=new $usof.Form(self.$activeElmFieldset);self.activeElmFieldset.tabsItems={};$('.usof-tabs-item',self.$activeElmFieldset).each((index,node)=>{self.activeElmFieldset.tabsItems[index]=$(node)});self.activeElmFieldset.on('dataIndicatorChanged',self._events.dataIndicatorChanged);$usb.panel.setTitle($usb.builder.getElmTitle(id));self.$activeElmFieldset.addClass('usof-container');self.activeElmFieldset.setValues(values);if($usb.find('preview')){$usb.preview.setFieldResponsiveScreen()}
for(const fieldId in self.activeElmFieldset.fields){const theField=self.activeElmFieldset.fields[fieldId];theField.on('change',self._events.changeField.bind(self,id)).on('afterHide',self._events.afterHideField).on('changeDesignField',self._events.changeDesignField.bind(self,id)).on('syncResponsiveState',(_,screenName)=>{if($usb.find('preview')){$usb.preview.fieldSetResponsiveScreen(screenName)}}).on('tinyMCE.Keydown',(_,e)=>$usb._events.keydown(e));}
for(const groupName in(self.activeElmFieldset.groups||{})){const theGroup=self.activeElmFieldset.groups[groupName];theGroup.on('change',$ush.debounce(self._events.changeField.bind(self,id),1))}
self.activeElmFieldset.$tabsItems=$('.usof-tabs-item',self.$activeElmFieldset);self.activeElmFieldset.$tabsSections=$('.usof-tabs-section',self.$activeElmFieldset);self.$$fieldsets.updateTabsVisibility();$usb.builder.trigger('panel.afterInitFieldset');$usb.postMessage('doAction',['showEditableHighlight',id])},_destroyElmFieldset:function(){const self=this;if(!$usb.panel.isReady()||!self.isActiveElmFieldset()){return}
if(self.$activeElmFieldset instanceof $){self.$activeElmFieldset.remove()}
$usb.$document.off('usb.syncResponsiveState');$usb.postMessage('doAction','hideEditableHighlight');$usb.builder.selectedElmId=null;self.activeElmFieldset=null;self.$activeElmFieldset=null},_loadAssetsForCodeEditor:function(){const codeEditorAssets=(_window.usGlobalData.deferredAssets||{})['codeEditor']||'';if(codeEditorAssets){$usb.$body.append(codeEditorAssets);delete _window.usGlobalData.deferredAssets.codeEditor}},_changeDesignField:function(selectedElmId,field,designField){if(field.type!=='design_options'){return}
this._changeField(selectedElmId,designField,designField.getValue(),!0)},__updateShortcode:$ush.throttle($ush.fn,1,!0),__updateShortcode_long:$ush.debounce($ush.fn,150),__updateOnInstructions_long:$ush.throttle($ush.fn,1000),isActiveElmFieldset:function(){return this.activeElmFieldset instanceof $usof.Form},_changeField:function(selectedElmId,usofField,_,_skipSave){const self=this;self.$$fieldsets.updateTabsVisibility.call(self);if(!selectedElmId||selectedElmId!==$usb.builder.selectedElmId){return}
const isGroup=usofField instanceof $usof.Group;const isField=usofField instanceof $usof.field;if(!(isField||isGroup)){return}
var value=usofField.getValue(),fieldType=(isField?usofField.type:'group'),usbParams=usofField[isField?'$row':'$container'].data('usb-params')||{},instructions=$usb._normalizeInstructions(usbParams.usb_preview);const _currentData={elmType:$usb.builder.getElmType(selectedElmId),fieldType:fieldType,id:selectedElmId,instructions:instructions,isChangeDesignOptions:(fieldType==='design_options'),isResponsiveValue:(isField?usofField.isResponsiveValue(value):!1),name:(usofField.name||usofField.groupName),usofField:usofField,value:value,};if(Array.isArray(instructions)){var previewCallbacks=$.isPlainObject(_window.usGlobalData.previewCallbacks)?_window.usGlobalData.previewCallbacks:{};for(const i in instructions){const funcName=$ush.toLowerCase(_currentData.elmType+'_'+_currentData.name);if(!instructions[i].callback||typeof previewCallbacks[funcName]!=='function'){continue}
try{instructions=previewCallbacks[funcName](_currentData.value)||!0}catch(err){$usb.log('Error executing callback function in instructions',err)}}
_currentData.instructions=$usb._normalizeInstructions(instructions)}
if((_currentData.isChangeDesignOptions&&$ush.rawurldecode(value).indexOf('"background-image":"{{')>-1)||(_currentData.name==='background-image'&&$ush.toString(value).indexOf('{{')>-1)){instructions=!0;_skipSave=!1}
_currentData.isActiveRecoveryTask=$usb.history.isActiveRecoveryTask();const _updateShortcode=(_currentData)=>{const deferred=$.Deferred();const originalId=_currentData.id;var isUpdated=!1;var oldShortcode=$usb.builder.getElmShortcode(originalId);if(!oldShortcode||_skipSave){return deferred.reject(isUpdated)}
const isContent=(_currentData.fieldType==='editor'||_currentData.name==='content');const hasDefaultValue=_currentData.usofField.getDefaultValue()===_currentData.value;var shortcodeObj=$usb.builder.parseShortcode(oldShortcode);var atts=$usb.builder.parseAtts(shortcodeObj.atts);if(isContent||hasDefaultValue){delete atts[_currentData.name]}else{atts[_currentData.name]=_currentData.value}
shortcodeObj.atts=$usb.builder.buildAtts(atts);if(isContent){shortcodeObj.content=_currentData.value}
var newShortcode=$usb.builder.buildShortcode(shortcodeObj),oldParentShortcode;isUpdated=(oldShortcode!==newShortcode&&!_currentData.isActiveRecoveryTask);if(_currentData.instructions===!0&&$usb.builder.isReloadParentElm(originalId)){_currentData.id=$usb.builder.getElmParentId(_currentData.id);oldParentShortcode=$usb.builder.getElmShortcode(_currentData.id)}
if(isUpdated){$usb.builder.pageData.content=$ush.toString($usb.builder.pageData.content).replace(oldShortcode,newShortcode);$ush.debounce_fn_1ms(()=>{$usb.trigger('builder.contentChange')})}
if(oldParentShortcode){oldShortcode=oldParentShortcode;newShortcode=$usb.builder.getElmShortcode(_currentData.id)}
if(isUpdated&&_currentData.elmType.indexOf('vc_row')===0&&['columns','columns_layout'].includes(_currentData.name)&&$usb.builder._updateColumnsLayout(_currentData.id,_currentData.value)){$usb.postMessage('showPreloader',_currentData.id);$usb.builder.renderShortcode('renderShortcode',{data:{content:$usb.builder.getElmShortcode(_currentData.id),},success:(res)=>{if(res.success){$usb.postMessage('updateSelectedElm',[_currentData.id,$ush.toString(res.data.html)])}},complete:()=>{deferred.resolve(isUpdated)}})}else{deferred.resolve(isUpdated)}
if(isUpdated){$usb.history.setLatestShortcodeUpdate({content:oldShortcode,preview:$usb.builder.getElmOuterHtml(_currentData.id)});var commitArgs=[_currentData.id,ACTION_CONTENT.UPDATE];commitArgs.push($usb.config('useThrottleForFields',[]).includes(_currentData.usofField.type));if(oldParentShortcode){commitArgs.push({originalId:originalId})}
$usb.history.commitChange.apply($usb.history,commitArgs)}
return deferred};const cache=$usbcore.cache('_changeField');if(_skipSave!==!0&&instructions===!0&&!_currentData.isActiveRecoveryTask){_updateShortcode(_currentData).always((isUpdated)=>{if(isUpdated&&instructions===!0){cache.set('shortcodeChanged',instructions)}
self.__updateShortcode_long(()=>{if(!isUpdated&&!cache.get('shortcodeChanged')){return}
cache.flush();var elmId=$usb.builder.getElmParentId(_currentData.id);if(!$usb.builder.isReloadElm(elmId)){elmId=_currentData.id}
$usb.builder.reloadElmInPreview(elmId,()=>{$usb.builder.trigger('shortcodeChanged',_currentData)})})})}
else if(instructions!==!0){const _updateOnInstructions=(_currentData)=>{_updateShortcode(_currentData).always((isUpdated)=>{if(!isUpdated||$ush.isUndefined(_currentData.instructions)){return}
if(_currentData.fieldType==='editor'&&typeof usofField.getHtmlContent==='function'){_currentData.value=usofField.getHtmlContent()}
else if(_currentData.isResponsiveValue){_currentData.value=$ush.toPlainObject(_currentData.value)}
$usb.postMessage('onPreviewParamChange',[_currentData.id,_currentData.instructions,_currentData.value,_currentData.fieldType,_currentData.isResponsiveValue]);$usb.builder.trigger('shortcodeChanged',_currentData)})};const _switchUpdateOnInstructions=()=>{if(_skipSave===!0){return}
if($usb.config('useLongUpdateForFields',[]).includes(_currentData.usofField.type)){self.__updateOnInstructions_long(_updateOnInstructions.bind(self,_currentData))}else{_updateOnInstructions(_currentData)}};if(_currentData.isChangeDesignOptions){const _value=unescape($ush.toString(_currentData.value));const attachmentId=$ush.parseInt((_value.match(/"background-image":"(\d+)"/)||[])[1]);if(attachmentId&&!$usb.getAttachmentUrl(attachmentId)){($usb.getAttachment(attachmentId)||{fetch:$.noop}).fetch({success:_switchUpdateOnInstructions})}else{_switchUpdateOnInstructions()}}else{_switchUpdateOnInstructions()}}},_afterHideField:function(usofField){if(usofField instanceof $usof.field&&usofField.inited){usofField.setValue(usofField.getDefaultValue(),!1)}},dataIndicatorChanged:function(hasValues){const self=this;if(!self.isActiveElmFieldset()){return}
for(const index in hasValues)if(self.activeElmFieldset.tabsItems[index]){self.activeElmFieldset.tabsItems[index].toggleClass('has_values',hasValues[index]===!0)}},});prototype.$$fieldsets={onSwitchTabs:function(e){const $target=$(e.currentTarget);const $sections=$target.parents('.usof-tabs:first').find('> .usof-tabs-sections > *');$target.addClass('active').siblings().removeClass('active');$sections.removeAttr('style').eq($target.index()).addClass('active').siblings().removeClass('active')},updateTabsVisibility:$ush.debounce(function(){const self=this;if(!self.activeElmFieldset||!(self.activeElmFieldset.$tabsItems instanceof $)){return}
$.each(self.activeElmFieldset.$tabsSections,(index,section)=>{const fields=$('> *',section).toArray();var isHidden=!0;for(const k in fields){var $field=$(fields[k]),isShown=$field.data('isShown');if($ush.isUndefined(isShown)){isShown=($field.css('display')!='none')}
if(isShown){isHidden=!1;break}}
self.activeElmFieldset.$tabsItems.eq(index).toggleClass('hidden',isHidden)})},1),};$usb.builderPanel=new BuilderPanel}(jQuery);!function($,undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};var _$tmp={template:''};function Navigator(container){const self=this;self._events={contentChange:self._contentChange.bind(self),duplicateElm:self._duplicateElm.bind(self),expand:self._expand.bind(self),expandAll:self._expandAll.bind(self),hide:self._hide.bind(self),iframeReady:self._iframeReady.bind(self),panelShowMessage:self._panelShowMessage.bind(self),removeElm:self._removeElm.bind(self),scrollTo:self._scrollTo.bind(self),selectedElm:self._selectedElm.bind(self),shortcodeChanged:self._shortcodeChanged.bind(self),showPreloader:self._showPreloader.bind(self),switch:self._switch.bind(self),urlManager:self._urlManager.bind(self),};$(()=>{self.$container=$(container);self.$body=$('.usb-navigator-body',self.$container);self.$actionHide=$('.usb_action_navigator_hide',self.$container);self.$actionSwitch=$('.usb_action_switch_navigator',$usb.$panel);self.$actionExpandAll=$('.usb_action_navigator_expand_all',self.$container);self.$container.on('click','.usb_action_navigator_hide',self._events.hide).on('click','.usb_action_navigator_expand_all',self._events.expandAll).on('click','.usb_action_navigator_expand',self._events.expand).on('click','.usb-navigator-item-header',$ush.debounce(self._events.selectedElm,0.5)).on('click','.usb_action_navigator_duplicate_elm',self._events.duplicateElm).on('click','.usb_action_navigator_remove_elm',self._events.removeElm);$usb.$panel.on('click','.usb_action_switch_navigator',self._events.switch);var $template=$('#usb-tmpl-navigator-item',self.$container);if($template.length){_$tmp.template=$template.html();$template.remove()}});self.on('showPreloader',self._events.showPreloader);$usb.on('iframeReady',self._events.iframeReady).on('builder.contentChange',self._events.contentChange).on('navigator.scrollTo',self._events.scrollTo).on('navigator.showPreloader',self._events.showPreloader).on('shortcodeChanged',self._events.shortcodeChanged).on('panel.showMessage',self._events.panelShowMessage).on('urlManager.changed',self._events.urlManager)}
$.extend(Navigator.prototype,$ush.mixinEvents,{isReady:function(){return!$ush.isUndefined(this.$container)},isShow:function(){return $usb.urlManager.hasParam('navigator','show')},_switch:function(){const urlManager=$usb.urlManager;if(!this.isShow()){urlManager.setParam('navigator','show')}else{urlManager.removeParam('navigator')}
urlManager.push()},_hide:function(){$usb.urlManager.removeParam('navigator').push()},show:function(){const self=this;if($usb.builder.isEmptyContent()){return}
self.$container.addClass('show');self.$actionSwitch.addClass('active');self.redraw()},hide:function(){this.$container.removeClass('show');this.$actionSwitch.removeClass('active')},_scrollTo:function(id){const self=this;if(!self.isShow()||!$usb.builder.isValidId(id)){return}
var $body=self.$body,$item=$(`[data-for="${id}"]`,$body);if(!$item.length){return}
const rect=$ush.$rect($item[0]);if(!(rect.top<0||rect.bottom>($body.height()||rect.height))){return}
var headerHeight=$('.usb-navigator-header',self.$container).height();$body[0].scrollTo(0,rect.top+$body.scrollTop()-headerHeight)},_showPreloader:function(id){const self=this;if(!self.isShow()||!$usb.builder.doesElmExist(id)){return}
var $item=$(`[data-for="${id}"]`,self.$body),$duplicateItem=$item.clone().removeAttr('data-for').removeClass('expand active').addClass('duplicate');$('> .usb-navigator-item-header .usb-navigator-item-title > i',$duplicateItem).after('<span class="usof-preloader"></span>').addClass('hidden');$item.after($duplicateItem)},_expand:function(e){const $item=$(e.target).closest('[data-for]');if($item.length){$item.toggleClass('expand',!$item.hasClass('expand'))}},_expandAll:function(){const self=this;const $action=self.$actionExpandAll;const $items=$('[data-for].has_children',self.$body).add($action);if(!$action.hasClass('expand')){$items.addClass('expand')}else{$items.removeClass('expand')}},_selectedElm:function(e){const $target=$(e.target);const id=$target.closest('[data-for]').data('for');if($target.hasClass('usb_action_navigator_expand')){return}
$ush.timeout(()=>{$usb.postMessage('doAction',['scrollToOutsideElm',id])},100);if($usb.builder.selectedElmId!==id){$usb.trigger('builder.elmSelected',id)}},_duplicateElm:function(e){const id=$(e.target).closest('[data-for]').data('for');if(!$usb.builder.doesElmExist(id)){return!1}
this.trigger('showPreloader',id);$usb.trigger('builder.elmDuplicate',id);return!1},_removeElm:function(e){const id=$(e.target).closest('[data-for]').data('for');if($usb.builder.doesElmExist(id)){$usb.trigger('builder.elmDelete',id)}},removeElm:function(id){const self=this;if(!self.isShow()||!$usb.builder.isValidId(id)){return}
$(`[data-for="${id}"]:first`,self.$body).remove()},setActive:function(id,expandParents){const self=this;if(!self.isShow()||!$usb.builder.doesElmExist(id)){return}
self.resetActive();$(`[data-for="${id}"]`,self.$body).addClass('active').parents('[data-for]').toggleClass('expand',!!expandParents)},resetActive:function(){const self=this;if(self.isShow()){$('[data-for].active',self.$body).removeClass('active')}},buttonControl:function(isDisabled){this.$actionSwitch.toggleClass('disabled',isDisabled)},redraw:function(){const self=this;if($usb.iframeIsReady!==!0||$usb.builder.isEmptyContent()||!self.isShow()){return}
const getItems=(elmsId,node,level)=>{if(!Array.isArray(elmsId)||elmsId.length===0){return node}
level++;elmsId.map((elmId)=>{const attrId=$usb.builder.getElmValue(elmId,'el_id','');const $item=$($usb.buildString(_$tmp.template,{attr_id:(attrId?'#'+attrId:''),in_editor_name:$usb.builder.getElmValue(elmId,'row_title',''),elm_icon:$usb.config('elm_icons.'+$usb.builder.getElmName(elmId),'no-icon'),elm_title:$usb.builder.getElmTitle(elmId),elm_type:$usb.builder.getElmType(elmId),usbid:elmId,}));var itemChildren=$usb.builder.getElmChildren(elmId);if(itemChildren.length){getItems(itemChildren,$item,level);$item.addClass('has_children').toggleClass('expand',$(`[data-for="${elmId}"].expand`,self.$body).length>0)}
$item.addClass(`level_${level}`);node.append($item.get(0))});return node}
self.$body.html(getItems($usb.builder.getElmChildren($usb.builder.mainContainer),new DocumentFragment,0));self.setActive($usb.builder.selectedElmId,!0)},_panelShowMessage:function(){this.resetActive()},_shortcodeChanged:function(data){const self=this;if(!$.isPlainObject(data)){return}
if(self.isShow()&&data.name==='el_id'){if(data.value){data.value='#'+data.value}
$(`[data-for="${data.id}"] .for_attr_id:first`,self.$body).text(data.value)}},_contentChange:function(){const self=this;const isEmptyContent=$usb.builder.isEmptyContent();if(isEmptyContent){self.hide()}
self.buttonControl(isEmptyContent);if(!isEmptyContent&&self.isShow()){$ush.debounce_fn_1ms(self.redraw.bind(self))}},_iframeReady:function(){const self=this;const isEmptyContent=$usb.builder.isEmptyContent();self.buttonControl(isEmptyContent);if(!isEmptyContent){self._urlManager($usb.urlManager.getDataOfChange())}
if(self.isShow()){$ush.timeout(self.redraw.bind(self),1)}},_urlManager:function(state){const self=this;if(!self.isReady()){return}
if(self.isShow()&&state.setParams.action===$usb.config('actions.site_settings')){self.hide();return}
if($usb.urlManager.hasParam('navigator','show')){self.show()}else{self.hide()}}});$usb.navigator=new Navigator('#usb-navigator')}(jQuery);!function($,_undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};var _$tmp={$categorySections:{},isLoaded:{},};function Templates(container){const self=this;self.name='templates';self._events={clickTabTemplates:self._clickTabTemplates.bind(self),expandCategory:self._expandCategory.bind(self),}
$(()=>{self.$container=$(container);self.$tabButton=$('.usb_action_show_templates',$usb.$panel);self.$error=$('.usb-templates-error',self.$container);$usb.$panel.on('click','.usb-template-title',self._events.expandCategory).on('click','.usb_action_show_templates',self._events.clickTabTemplates)})}
$.extend(Templates.prototype,$ush.mixinEvents,{isReady:function(){return!$ush.isUndefined(this.$container)},isShow:function(){return this.$container.is(':visible')},isTemplate:function(id){const self=this;if($usb.builder.isValidId(id)){id=$usb.builder.getElmType(id)}
return id==='import_template'},configIsLoaded:function(){return!$.isEmptyObject(_$tmp.$categorySections)},categoryIsLoaded:function(categoryId){return _$tmp.isLoaded.hasOwnProperty(categoryId)},templateIsLoaded:function(categoryId){return this.categoryIsLoaded(categoryId)&&_$tmp.isLoaded[categoryId]},_clickTabTemplates:function(){const self=this;if(!self.configIsLoaded()){self._loadConfig()}
if($usb.licenseIsActivated()){$usb.builder.initDragDrop()}
if($usb.find('builderPanel')){$usb.builderPanel.$actionAddElms.addClass('active')}
$('.usb-template',self.$container).removeClass('expand')},_expandCategory:function(e){const self=this;const categoryId=$(e.currentTarget).parent().data('template-category-id');if(!categoryId){return}
if($usb.licenseIsActivated()){self._loadTemplates(categoryId)}
const $activeTemplate=$('.usb-template.expand',self.$container);if($activeTemplate.data('template-category-id')===categoryId){$activeTemplate.removeClass('expand');return}
function showSectionById(categoryId){$('.usb-template',self.$container).removeClass('expand').filter(`[data-template-category-id="${categoryId}"]`).addClass('expand')};if(!self.configIsLoaded()){self.one('configLoaded',showSectionById.bind(self,categoryId))}else{showSectionById(categoryId)}},_loadConfig:function(){const self=this;if(self.configIsLoaded()){return}
$usb.panel.showPreloader();$usb.ajax('templates.loadConfig',{data:{_nonce:$usb.config('_nonce'),action:$usb.config('action_get_templates_config'),},success:(res)=>{if(!res.success||!$.isPlainObject(res.data)){self.$error.addClass('active');return}
for(categoryId in res.data){if(_$tmp.$categorySections[categoryId]){continue}
const categorySection=res.data[categoryId];if(categorySection){self.$container.append(categorySection);_$tmp.$categorySections[categoryId]=$(categorySection)}}
self.trigger('configLoaded')},complete:()=>{$usb.panel.hidePreloader()},})},_loadTemplates:function(categoryId){const self=this;if($ush.isUndefined(categoryId)||categoryId==''||self.templateIsLoaded(categoryId)){return}
$usb.ajax('templates.loadTemplates',{data:{_nonce:$usb.config('_nonce'),action:$usb.config('action_preload_template_category'),template_category_id:categoryId,},success:(res)=>{_$tmp.isLoaded[categoryId]=res.success;if(!res.success){return}
self.trigger('templatesLoaded',[categoryId])},})},insertTemplate:function(categoryId,templateId,parentId,currentIndex){const self=this;if(!categoryId){$usb.log('Error: Template category ID is not set',args);return}
if(!templateId){$usb.log('Error: Template ID is not set',args);return}
if(!$usb.builder.isMainContainer(parentId)){$usb.log('Error: Invalid parent container, templates can only be added to mainContainer',args);return}
const insert=$usb.builder.getInsertPosition(parentId,currentIndex);const _getTemplateData=function(){$usb.postMessage('showPreloader',[insert.parent,insert.position,]);$usb.builder.renderShortcode('templates.insertTemplate',{data:{template_category_id:categoryId,template_id:templateId,isReturnContent:!0},success:(res)=>{$usb.postMessage('hidePreloader',insert.parent);if(!res.success||!res.data.content||!res.data.html){return}
const newData=$usb.builder.updateIdsInContent(res.data.content,res.data.html);if(!$usb.builder.insertShortcodeIntoContent(parentId,currentIndex,newData.content)){return!1}
$usb.postMessage('insertElm',[insert.parent,insert.position,newData.html]);if($usb.builder.isRow(newData.firstElmId)){$usb.history.commitChange(newData.firstElmId,ACTION_CONTENT.CREATE)}
$ush.timeout(()=>{$usb.builder.reloadElementsMap()},0);$usb.trigger('builder.contentChange')}})};if(!self.templateIsLoaded(categoryId)){self.off('templatesLoaded').one('templatesLoaded',(_categoryId)=>{if(categoryId==_categoryId){_getTemplateData()}});if(self.categoryIsLoaded(categoryId)){$usb.log('Error: Failed to load template category:',[categoryId])}
return}
_getTemplateData()}});$usb.templates=new Templates('#usb-templates')}(jQuery);!function($,_undefined){var _$tmp={deleteSectionId:0,listIsLoaded:!1,sectionContent:'',};function Favorites(container){const self=this;self._events={changeSectionName:self._changeSectionName.bind(self),clickTabFavorites:self._clickTabFavorites.bind(self),deleteSection:self._deleteSection.bind(self),reorderSections:$ush.debounce(self._reorderSections.bind(self),1),resetSearch:self._resetSearch.bind(self),saveToFavorites:self._saveToFavorites.bind(self),saveToFavoritesByPressEnter:self._saveToFavoritesByPressEnter.bind(self),search:self._search.bind(self),setExampleValueToSectionName:self._setExampleValueToSectionName.bind(self),showConfirmDelete:self._showConfirmDelete.bind(self),showList:self.showList.bind(self),showPopupToGetName:self._showPopupToGetName.bind(self),};$(()=>{self.$container=$(container);self.$search=$('.usb-panel-search',container);self.$searchField=$('input[name=search]',container);self.$searchNoResult=$('.usb-panel-search-noresult',container);self.$list=$('.usb-favorites-list',container);self.$emptyList=$('.usb-favorites-empty-list',container);self.$confirmDeletion=$('.usb-favorites-confirm-deletion',container);self.$container.on('input','input[name=search]',$ush.debounce(self._events.search,1)).on('click','.usb_action_reset_search_in_panel',self._events.resetSearch).on('click','.usb_action_show_confirm_delete',self._events.showConfirmDelete).on('click','.usb_action_delete_from_favorites',self._events.deleteSection).on('click','.usb_action_cancel_deletion_from_favorites',self._events.showList);$usb.$panel.on('click','.usb_action_show_favorites',self._events.clickTabFavorites);const dragDrop=new $usof.dragDrop(self.$list,'.usb-favorites-item',!0);dragDrop.on('changed',self._events.reorderSections);self.popup=new $usof.popup('popup_save_to_favorites',{closeOnEsc:!0,closeOnBgClick:!0,init:function(){const $popup=this.$container;self.$inputSectionName=$('input[name=section_name]',$popup);self.$saveButton=$('.usb_action_save_to_favorites',$popup);self.$errMessage=$('.usof-message.status_error',$popup);$($popup).on('input','input[name=section_name]',self._events.changeSectionName).on('keyup','input[name=section_name]',$ush.debounce(self._events.saveToFavoritesByPressEnter,1)).on('click','.usb_action_save_to_favorites',self._events.saveToFavorites).on('click','.usof-example',self._events.setExampleValueToSectionName)},afterShow:()=>{$ush.timeout(()=>{self.$inputSectionName[0].focus()},20)},afterHide:()=>{self.$inputSectionName.removeClass('is_invalid').val('');_$tmp.sectionContent=''}})});$usb.on('favorites.saveToFavorites',self._events.showPopupToGetName)}
$.extend(Favorites.prototype,$ush.mixinEvents,{isReady:function(){return!$ush.isUndefined(this.$container)},isShow:function(){return this.$container.is(':visible')},isFavoriteSection:function(id){if($usb.builder.isValidId(id)){id=$usb.builder.getElmType(id)}
return id==='favorite_section'},_clickTabFavorites:function(){const self=this;if(_$tmp.listIsLoaded||!$usb.licenseIsRealActivated()){self.showList();return}
$usb.panel.showPreloader();$usb.ajax('favorites.clickTabFavorites',{data:{_nonce:$usb.config('_nonce'),action:$usb.config('action_get_favorites'),},success:(res)=>{if(res.success&&res.data){self.$list.html(res.data)}},complete:()=>{$usb.panel.hidePreloader();$ush.timeout(self.showList.bind(self),1);_$tmp.listIsLoaded=!0},})},_search:function(){const self=this;const $input=self.$searchField;const value=$ush.toLowerCase($input[0].value).trim();const $items=$('.usb-favorites-item',self.$list);var isFoundResult=!0;if(!$items.length){return}
$input.next('.usb_action_reset_search_in_panel').toggleClass('hidden',!value);if(value){$items.addClass('hidden');isFoundResult=$items.filter(`[data-search-text^="${value}"], [data-search-text*="${value}"]`).removeClass('hidden').length>0}else{$items.removeClass('hidden')}
self.$searchNoResult.toggleClass('hidden',isFoundResult)},_resetSearch:function(){const $input=this.$searchField;if($input.val()){$input.val('').trigger('input')}},showList:function(){const self=this;const listIsEmpty=self.$list.is(':empty');self.$confirmDeletion.addClass('hidden');self.$list.toggleClass('hidden',listIsEmpty);self.$emptyList.toggleClass('hidden',!listIsEmpty);self.$search.toggleClass('hidden',listIsEmpty);self.$container.toggleClass('is_empty_list',listIsEmpty);if(!listIsEmpty){$ush.timeout(()=>{self.$searchField[0].focus()},10)}},_showConfirmDelete:function(e){const self=this;const $target=$(e.target).closest('.usb-favorites-item');const name=$('.usb-favorites-item-title:first',$target).text();self.$search.addClass('hidden');self.$emptyList.addClass('hidden');self.$list.addClass('hidden');self.$confirmDeletion.removeClass('hidden').find('.for_section_name').text(name);_$tmp.deleteSectionId=$target.data('section-id')},_showPopupToGetName:function(id){const self=this;if(!self.isReady()||!$usb.builder.isValidId(id)||!self.popup){return}
_$tmp.sectionContent=$usb.builder.getElmShortcode(id);self.$errMessage.addClass('hidden');self.popup.show()},_changeSectionName:function(e){const $target=$(e.currentTarget);$target.toggleClass('is_invalid',!$target.val())},_setExampleValueToSectionName:function(e){$usbcore.setTextToCaretPosition(this.$inputSectionName[0],e.currentTarget.innerHTML)},_saveToFavorites:function(){const self=this;const sectionName=self.$inputSectionName.val();if(!sectionName.trim()){self.$inputSectionName.addClass('is_invalid');return}
self.$saveButton.addClass('loading');self.$errMessage.addClass('hidden');$usb.ajax('favorites.saveToFavorites',{data:{_nonce:$usb.config('_nonce'),action:$usb.config('action_save_to_favorites'),section_name:sectionName,section_content:_$tmp.sectionContent,},success:(res)=>{if(!res.success){self.$errMessage.text(res.data.message).removeClass('hidden');return}
_$tmp.sectionContent='';if(res.data){self.$list.prepend(res.data);self.showList()}
self.popup.hide();self.$inputSectionName.val('')},complete:()=>{self.$saveButton.removeClass('loading')},})},_saveToFavoritesByPressEnter:function(e){if(e.keyCode===$ush.ENTER_KEYCODE){this._saveToFavorites()}},_deleteSection:function(){const self=this;$usb.panel.showPreloader();$usb.ajax('favorites.deleteSection',{data:{_nonce:$usb.config('_nonce'),action:$usb.config('action_delete_from_favorites'),section_id:_$tmp.deleteSectionId,},success:(res)=>{if(res.success){$(`[data-section-id="${_$tmp.deleteSectionId}"]`,self.$list).remove()}},complete:()=>{$usb.panel.hidePreloader();$ush.timeout(self.showList.bind(self),1)},})},_reorderSections:function(){const self=this;const orderedIDs=[];$('> *',self.$list).each((_,node)=>{orderedIDs.push($usbcore.$attr(node,'data-section-id'))});$usb.panel.showPreloader();$usb.ajax('favorites.reorderSections',{data:{_nonce:$usb.config('_nonce'),action:$usb.config('action_reorder_favorite_sections'),ordered_ids:orderedIDs,},complete:()=>{$usb.panel.hidePreloader()},})},insertSection:function(sectionId,parentId,currentIndex){const self=this;const insert=$usb.builder.getInsertPosition(parentId,currentIndex);$usb.postMessage('showPreloader',[insert.parent,insert.position,]);$usb.builder.renderShortcode('favorites.insertSection',{data:{section_id:sectionId,isReturnContent:!0},success:(res)=>{$usb.postMessage('hidePreloader',insert.parent);if(!res.success||!res.data.content||!res.data.html){return}
const newData=$usb.builder.updateIdsInContent(res.data.content,res.data.html);if(!$usb.builder.insertShortcodeIntoContent(parentId,currentIndex,newData.content)){return!1}
$usb.postMessage('insertElm',[insert.parent,insert.position,newData.html]);if($usb.builder.isRow(newData.firstElmId)){$usb.history.commitChange(newData.firstElmId,ACTION_CONTENT.CREATE)}
$ush.timeout(()=>{$usb.builder.reloadElementsMap()},0);$usb.trigger('builder.contentChange')}})},});$usb.favorites=new Favorites('#usb-favorites')}(jQuery);!function($,undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};var _$tmp={isInputCustomCss:!1,pageFieldset:{},};function Page(){const self=this;self._events={changePageCustomCss:self._changePageCustomCss.bind(self),changePostMeta:self._changePostMeta.bind(self),changeSettings:self._changeSettings.bind(self),handlerClearBody:self._handlerClearBody.bind(self),iframeReady:self._iframeReady.bind(self),setParamsForSettings:self._setParamsForSettings.bind(self),showCustomCss:self._showCustomCss.bind(self),showSettings:self._showSettings.bind(self),urlManager:self._urlManager.bind(self),};$(()=>{self.$pageSettings=$('.usb-panel-page-settings',$usb.$panel);self.$pageCustomCss=$('.usb-panel-page-custom-css',$usb.$panel);self.$actionShowCustomCss=$('.usb_action_show_page_custom_css',$usb.$panel);self.$actionShowSettings=$('.usb_action_show_page_settings',$usb.$panel);$usb.$panel.on('click','.usb_action_show_page_settings',self._events.showSettings).on('click','.usb_action_show_page_custom_css',self._events.showCustomCss);self._urlManager($usb.urlManager.getDataOfChange())});$usb.on('iframeReady',self._events.iframeReady).on('panel.clearBody',self._events.handlerClearBody).on('urlManager.changed',self._events.urlManager)}
const prototype=Page.prototype;$.extend(prototype,$ush.mixinEvents,{_urlManager:function(state){const self=this;if(!self.isReady()){return}
if(state.setParams.active=='page_settings'){self.showSettings()}
else if(state.setParams.active=='page_custom_css'){if(!$usb.iframeIsReady){$usb.one('iframeReady',self.showCustomCss.bind(self))}else{self.showCustomCss()}}},_iframeReady:function(){const self=this;if($usb.builder.pageData.customCss){self.$actionShowCustomCss.addClass('css_not_empty')}},_handlerClearBody:function(){const self=this;if(!self.isReady()){return}
self._hideSettings();self._hideCustomCss()}});$.extend(prototype,{isReady:function(){return!$ush.isUndefined(this.$pageSettings)},_showSettings:function(){$usb.urlManager.setParam('active','page_settings').push()},showSettings:function(){const self=this;if(!(_$tmp.pageFieldset.pageFields instanceof $usof.GroupParams)){var pageFields=new $usof.GroupParams($('.for_page_fields',self.$pageSettings)[0]);for(var k in pageFields.fields){pageFields.fields[k].on('change',$ush.debounce(self._events.changeSettings,1))}
_$tmp.pageFieldset.pageFields=pageFields}
if(!(_$tmp.pageFieldset.postMeta instanceof $usof.GroupParams)){var postMeta=new $usof.GroupParams($('.usb-panel-page-meta',self.$pageSettings)[0]);for(var k in postMeta.fields){postMeta.fields[k].on('change',$ush.debounce(self._events.changePostMeta,1))}
_$tmp.pageFieldset.postMeta=postMeta}
self._setParamsForSettings();$usb.panel.clearBody();$usb.navigator.resetActive();self.$pageSettings.removeClass('hidden');self.$actionShowSettings.addClass('active');$usb.panel.setTitle('page_settings',!0)},_hideSettings:function(){var self=this;self.$pageSettings.addClass('hidden');self.$actionShowSettings.removeClass('active')},_setParamsForSettings:function(){const self=this;if(!$usb.iframeIsReady){$usb.one('iframeReady',self._events.setParamsForSettings);self.$pageSettings.addClass('data_loading');return}
var pageData=$usb.builder.pageData,postMeta=_$tmp.pageFieldset.postMeta,pageFields=_$tmp.pageFieldset.pageFields;if(pageFields instanceof $usof.GroupParams){pageFields.setValues(pageData.fields,!0);$.extend(pageData.fields,pageFields.getValues())}
if(postMeta instanceof $usof.GroupParams){postMeta.setValues(pageData.postMeta,!0);$.extend(pageData.postMeta,postMeta.getValues())}
self.$pageSettings.removeClass('data_loading')},_changeSettings:function(usofField,value){if(!(usofField instanceof $usof.field)){return}
const name=usofField.name;if($usb.builder.pageData.fields[name]===value){return}
$usb.builder.pageData.fields[name]=value;if(name==='post_title'){document.title=$usb.config('adminPageTitleMask',value).replace('%s',value);const selectors='.post_title:not([class*="usg_post_title_"]), head > title';$usb.postMessage('updateElmContent',['.post_title:not([class*="usg_post_title_"]), head > title',value,'text'])}
if(name==='thumbnail_id'&&(usofField.$row.data('usb-params')||{}).usb_preview===!0){$usb.builder._isReloadPreviewAfterSave=!0}
$ush.debounce_fn_1ms(()=>{$usb.trigger('builder.contentChange')})},_changePostMeta:function(usofField,value){if(!(usofField instanceof $usof.field)){return}
const self=this;const name=usofField.name;if($usb.builder.pageData.postMeta[name]===value){return}
$usb.builder.pageData.postMeta[name]=value;if((usofField.$row.data('usb-params')||{}).usb_preview){$usb.builder._isReloadPreviewAfterSave=!0}
$ush.debounce_fn_1ms(()=>$usb.trigger('builder.contentChange'))},_showCustomCss:function(){$usb.urlManager.setParam('active','page_custom_css').push()},showCustomCss:function(){const self=this;if(!$usb.iframeIsReady){$usb.off('iframeReady',self._events.showCustomCss).one('iframeReady',self._events.showCustomCss);return}
$usb.builderPanel._loadAssetsForCodeEditor();if(!(_$tmp.pageFieldset.pageCustomCss instanceof $usof.field)){var pageCustomCss=new $usof.field($('.type_css',self.$pageCustomCss)[0]);pageCustomCss.init(pageCustomCss.$row);pageCustomCss.setValue($usb.builder.pageData.customCss);pageCustomCss.on('change',$ush.debounce(self._events.changePageCustomCss,1));_$tmp.pageFieldset.pageCustomCss=pageCustomCss}
$usb.panel.clearBody();$usb.navigator.resetActive();self.$pageCustomCss.removeClass('hidden');self.$actionShowCustomCss.addClass('active');$usb.panel.setTitle('page_custom_css',!0);try{var cmInstance=_$tmp.pageFieldset.pageCustomCss.editor.codemirror;cmInstance.focus();cmInstance.setCursor(cmInstance.lineCount(),0)}catch(err){}},_hideCustomCss:function(){const self=this;if(self.isReady()){self.$pageCustomCss.addClass('hidden');self.$actionShowCustomCss.removeClass('active')}},__debounce_2s:$ush.debounce($ush.fn,2000),_changePageCustomCss:function(usofField,pageCustomCss){const self=this;if($usb.hotkeys('ctrl+z','ctrl+shift+z')){return}
const setPageCustomCss=function(customCss,originalTask){if($.type(customCss)!=='string'||$usb.builder.pageData.customCss==customCss){return}
if($usb.history.isActiveRecoveryTask()&&$.isPlainObject(originalTask)){_$tmp.pageFieldset.pageCustomCss.setValue(customCss);originalTask.data=''+$usb.builder.pageData.customCss}
$usb.builder.pageData.customCss=customCss;$usb.postMessage('updatePageCustomCss',customCss);$ush.debounce_fn_1ms(()=>$usb.trigger('builder.contentChange'));self.$actionShowCustomCss.toggleClass('css_not_empty',!!customCss)};if(!_$tmp.isInputCustomCss){$usb.history.commitData($usb.builder.pageData.customCss,setPageCustomCss);_$tmp.isInputCustomCss=!0}
else{self.__debounce_2s(()=>{_$tmp.isInputCustomCss=!1})}
setPageCustomCss(pageCustomCss)}});$usb.page=new Page}(jQuery);!function($,_undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usof=_window.$usof||{};_window.$usbcore=_window.$usbcore||{};const _changesHistory={redo:[],tasks:[],undo:[]};const _$tmp={isActiveRecoveryTask:!1,_latestShortcodeUpdate:{},};function History(){const self=this;self._events={historyChanged:self.historyChanged.bind(self),redoChange:self.redoChange.bind(self),undoChange:self.undoChange.bind(self),};$(()=>{self.$actionUndo=$('.usb_action_undo',$usb.$panel);self.$actionRedo=$('.usb_action_redo',$usb.$panel);$usb.$panel.on('click','.usb_action_undo',self._events.undoChange).on('click','.usb_action_redo',self._events.redoChange)});$usb.on('hotkeys.ctrl+z',self._events.undoChange).on('hotkeys.ctrl+shift+z',self._events.redoChange);self.on('historyChanged',self._events.historyChanged)}
$.extend(History.prototype,$ush.mixinEvents,{undoChange:function(){this._createRecoveryTask(HISTORY_TYPE.UNDO)},redoChange:function(){this._createRecoveryTask(HISTORY_TYPE.REDO)},historyChanged:function(){const self=this;[{$btn:self.$actionUndo,disabled:!self.getLengthUndo()},{$btn:self.$actionRedo,disabled:!self.getLengthRedo()}].map((i)=>{i.$btn.toggleClass('recovery_process',!!self.getLengthTasks()).toggleClass('disabled',i.disabled).prop('disabled',i.disabled)})},getLengthUndo:function(){return _changesHistory.undo.length},getLengthRedo:function(){return _changesHistory.redo.length},getLengthTasks:function(){return _changesHistory.tasks.length},getLastHistoryDataByAction:function(action){const self=this;var lastData,undo=_changesHistory.undo;if(self.getLengthUndo()&&$usbcore.indexOf(action,ACTION_CONTENT)>-1){for(var i=self.getLengthUndo()-1;i>=0;i--){if((undo[i]||{}).action===action){lastData=$ush.clone(undo[i]);break}}}
return lastData||{}},setLatestShortcodeUpdate:function(data){_$tmp._latestShortcodeUpdate=$ush.toPlainObject(data)},isActiveRecoveryTask:function(){return!!_$tmp.isActiveRecoveryTask},__saveDataToHistory:$ush.throttle($ush.fn,2000,!0),commitChange:function(id,action,useThrottle,extData){const self=this;if(!action||!$usb.builder.isValidId(id)||self.isActiveRecoveryTask()||$usbcore.indexOf(action,ACTION_CONTENT)<0){return}
const saveDataToHistory=()=>{var data={action:action,id:id,extData:$.isPlainObject(extData)?extData:{},};if([ACTION_CONTENT.MOVE,ACTION_CONTENT.REMOVE].includes(action)){data.index=$usb.builder.getElmIndex(id);data.parentId=$usb.builder.getElmParentId(id)}
if([ACTION_CONTENT.UPDATE,ACTION_CONTENT.REMOVE].includes(action)){data.content=$usb.builder.getElmShortcode(id);data.preview=$usb.builder.getElmOuterHtml(id);const pcre=new RegExp('class="(.*)?'+$usb.config('className.elmLoad','usb-elm-loading')+'(\s|")');if(data.preview&&pcre.test(data.preview)){return}}
if(ACTION_CONTENT.UPDATE===action&&!$.isEmptyObject(_$tmp._latestShortcodeUpdate)){$.extend(data,_$tmp._latestShortcodeUpdate);_$tmp._latestShortcodeUpdate={}}
if(ACTION_CONTENT.REMOVE===action){data.values=$usb.builder.getElmValues(id)}
if(ACTION_CONTENT.UPDATE===action){var lastData=self.getLastHistoryDataByAction(ACTION_CONTENT.UPDATE);const props=['index','parentId','timestamp'];if(!$.isEmptyObject(lastData)&&$ush.comparePlainObject($usbcore.clearPlainObject(lastData,props),$usbcore.clearPlainObject(data,props))){return}}
if(self.getLengthUndo()>=$ush.parseInt($usb.config('maxDataHistory',100))){_changesHistory.undo=_changesHistory.undo.slice(1)}
_changesHistory.undo.push($.extend(data,{timestamp:Date.now()}));_changesHistory.redo=[];self.trigger('historyChanged')};if(!!useThrottle){self.__saveDataToHistory(saveDataToHistory)}else{saveDataToHistory()}},commitData:function(customData,callback,useThrottle){const self=this;if($ush.isUndefined(customData)||typeof callback!=='function'){return}
const saveDataToHistory=()=>{var data={action:ACTION_CONTENT.CALLBACK,callback:callback,data:customData};var lastData=self.getLastHistoryDataByAction(ACTION_CONTENT.CALLBACK);if(!$.isEmptyObject(lastData)&&$ush.comparePlainObject($usbcore.clearPlainObject(lastData,['callback','timestamp']),$usbcore.clearPlainObject(data,'callback'))){return}
if(self.getLengthUndo()>=$ush.parseInt($usb.config('maxDataHistory',100))){_changesHistory.undo=_changesHistory.undo.slice(1)}
_changesHistory.undo.push($.extend(data,{timestamp:Date.now()}));_changesHistory.redo=[];self.trigger('historyChanged')};if(!!useThrottle){self.__saveDataToHistory(saveDataToHistory)}else{saveDataToHistory()}},_createRecoveryTask:function(type){const self=this;if(!type||![HISTORY_TYPE.UNDO,HISTORY_TYPE.REDO].includes(type)){return}
var task,lengthUndo=self.getLengthUndo(),lengthRedo=self.getLengthRedo();if(type===HISTORY_TYPE.UNDO&&lengthUndo){task=_changesHistory.undo[--lengthUndo];_changesHistory.undo=_changesHistory.undo.slice(0,lengthUndo)}
if(type===HISTORY_TYPE.REDO&&lengthRedo){task=_changesHistory.redo[--lengthRedo];_changesHistory.redo=_changesHistory.redo.slice(0,lengthRedo)}
if(!$.isEmptyObject(task)){_changesHistory.tasks.push($ush.clone(task,{type:type}));self.trigger('historyChanged');self.__startRecoveryTasks.call(self)}},__startRecoveryTasks:$ush.debounce(function(){const self=this;if(self.isActiveRecoveryTask()){return}
_$tmp.isActiveRecoveryTask=!0;self._recoveryTaskManager()},100),_recoveryTaskManager:function(){const self=this;var lengthTasks=self.getLengthTasks(),task=_changesHistory.tasks[--lengthTasks];if($.isEmptyObject(task)){_$tmp.isActiveRecoveryTask=!1;self.trigger('historyChanged');return}
_changesHistory.tasks=_changesHistory.tasks.slice(0,lengthTasks);$ush.timeout(self._applyChangesFromTask.bind(self,$ush.clone(task),task),1);switch(task.action){case ACTION_CONTENT.CREATE:task.action=ACTION_CONTENT.REMOVE;break;case ACTION_CONTENT.REMOVE:task.action=ACTION_CONTENT.CREATE;break}
if([ACTION_CONTENT.UPDATE,ACTION_CONTENT.REMOVE].includes(task.action)){task.content=$usb.builder.getElmShortcode(task.id);task.preview=$usb.builder.getElmOuterHtml(task.id)}
if([ACTION_CONTENT.MOVE,ACTION_CONTENT.REMOVE].includes(task.action)){task.index=$usb.builder.getElmIndex(task.id);task.parentId=$usb.builder.getElmParentId(task.id)}
var type=task.type;delete task.type;if(type===HISTORY_TYPE.UNDO){_changesHistory.redo.push(task)}else{_changesHistory.undo.push(task)}},_applyChangesFromTask:function(task,originalTask){const self=this;if($.isEmptyObject(task)){_$tmp.isActiveRecoveryTask=!1;return}
if(!task.action){$usb.log('Error: Invalid change action:',task);return}
if(task.action===ACTION_CONTENT.CREATE){$usb.builder.removeElm(task.id)}else if(task.action===ACTION_CONTENT.MOVE){$usb.builder.moveElm(task.id,task.parentId,task.index)}else if(task.action===ACTION_CONTENT.REMOVE){if(!$usb.builder.insertShortcodeIntoContent(task.parentId,task.index,task.content)){return!1}
var insert=$usb.builder.getInsertPosition(task.parentId,task.index);$usb.postMessage('insertElm',[insert.parent,insert.position,''+task.preview]);$usb.postMessage('maybeInitElmJS',[task.id])}else if(task.action===ACTION_CONTENT.UPDATE){$usb.builder.pageData.content=(''+$usb.builder.pageData.content).replace($usb.builder.getElmShortcode(task.id),task.content);$usb.postMessage('updateSelectedElm',[task.id,''+task.preview]);const id=(task.extData||{}).originalId||task.id;if(id===$usb.builder.selectedElmId&&$usb.builderPanel.activeElmFieldset instanceof $usof.Form){$usb.builderPanel.activeElmFieldset.setValues($usb.builder.getElmValues($usb.builder.selectedElmId),!0)}}else if(task.action===ACTION_CONTENT.CALLBACK){if(typeof task.callback==='function'){task.callback.call(self,$ush.clone(task).data,originalTask)}}else{$usb.log('Error: Unknown recovery action:',action);return}
if([ACTION_CONTENT.UPDATE,ACTION_CONTENT.REMOVE].includes(task.action)){$usb.trigger('builder.contentChange')}
self.trigger('historyChanged');$usb.trigger('history.changed',task);$ush.timeout(self._recoveryTaskManager.bind(self),0)}});$usb.history=new History}(jQuery);!function($,undefined){const _window=window;if(!_window.$usb){return}
_window.$ush=_window.$ush||{};_window.$usbcore=_window.$usbcore||{};var _$tmp={fieldsets:{},isProcessSave:!1,savedLiveOptions:{},};function SiteSettings(container){const self=this;self.selectedGroupId;self.activeFieldset;self.$activeFieldset;if($usb.urlManager.hasParam('action',$usb.config('actions.site_settings'))){_window.onbeforeunload=function(e){$usb.postMessage('clearCookies')}}
self._events={changeField:self._changeField.bind(self),clickGoToBack:self._clickGoToBack.bind(self),clickGroupId:self._clickGroupId.bind(self),confirmExit:self._confirmExit.bind(self),handlerClearBody:self._handlerClearBody.bind(self),iframeReady:self._iframeReady.bind(self),saveChanges:self._saveChanges.bind(self),urlManager:self._urlManager.bind(self),};$(()=>{self.$container=$(container);self.$menu=$('.usb-panel-site-settings-menu',$usb.$panel);self.$actionGoToBack=$('.usb_action_go_to_back',$usb.$panel);var $fieldsets=$('#usb-site-settings-fieldsets',self.$container);if($fieldsets.is('[onclick]')){_$tmp.fieldsets=$fieldsets[0].onclick()||{};$fieldsets.remove()}
$usb.$panel.on('click','[data-group-id]',self._events.clickGroupId).on('click','.usb_action_go_to_back',self._events.clickGoToBack).on('click','a:not([target=_blank])',self._events.confirmExit);self._urlManager($usb.urlManager.getDataOfChange())});$usb.on('iframeReady',self._events.iframeReady).on('panel.clearBody',self._events.handlerClearBody).on('panel.saveChanges',self._events.saveChanges).on('hotkeys.ctrl+s',self._events.saveChanges).on('urlManager.changed',self._events.urlManager)}
const prototype=SiteSettings.prototype;$.extend(prototype,{_urlManager:function(state){const self=this;var _siteSettings=$usb.config('actions.site_settings');if(!self.isReady()){return}
if(state.setParams.action===_siteSettings){var groupId=state.setParams.group;if(groupId&&self.selectedGroupId!==groupId){if(!$usb.iframeIsReady){$usb.panel.showPreloader();$usb.one('iframeReady',self.initFieldset.bind(self,groupId))}else{self.initFieldset(groupId)}}
else if(!groupId){self.showGeneralMenu()}
self.$actionGoToBack.toggleClass('disabled',!state.setParams.group)}
else if(state.oldParams.action===_siteSettings){self._handlerClearBody();_$tmp.savedLiveOptions={};$usb.urlManager.removeParam('group').push()}},_confirmExit:function(e){const message=$usb.getTextTranslation('page_leave_warning');if(this.isChanged()&&!confirm(message)){e.preventDefault();return}},_iframeReady:function(){const self=this;if(!$usb.iframeIsReady||!$usb.urlManager.hasParam('action',$usb.config('actions.site_settings'))){return}
const iframeWindow=$usb.iframe.contentWindow;self.liveOptions=$ush.clone((iframeWindow.usGlobalData||{}).liveOptions||{});if($.isEmptyObject(_$tmp.savedLiveOptions)){_$tmp.savedLiveOptions=$ush.clone(self.liveOptions)}
$usb.panel.hidePreloader()},_handlerClearBody:function(){this._destroyFieldset();$usb.postMessage('clearCookies')}});$.extend(prototype,{isReady:function(){return!$ush.isUndefined(this.$container)},isChanged:function(){return!$ush.comparePlainObject(_$tmp.savedLiveOptions,this.liveOptions||{})},isProcessSave:function(){return _$tmp.isProcessSave},showGeneralMenu:function(){const self=this;if(!self.isReady()){return}
$usb.panel.setTitle('site_settings',!0);$usb.trigger('panel.clearBody');self.$menu.removeClass('hidden')},_clickGroupId:function(e){const groupId=$usbcore.$attr(e.currentTarget,'data-group-id');if(groupId){$usb.urlManager.setParam('group',groupId).push()}},_clickGoToBack:function(){$usb.urlManager.removeParam('group').push()},initFieldset:function(groupId){const self=this;if($ush.isUndefined(_$tmp.fieldsets[groupId])){return}
self.$menu.addClass('hidden');var groupTitle=$usb.config(`site.group_titles.${groupId}`);if(groupTitle){$usb.panel.setTitle(groupTitle)}
self.$activeFieldset=$(_$tmp.fieldsets[groupId]);$usb.$panelBody.prepend(self.$activeFieldset);self.selectedGroupId=groupId;self.activeFieldset=new $usof.GroupParams(self.$activeFieldset);self.$activeFieldset.addClass('inited usof-container');self.activeFieldset.setValues(self.liveOptions||{},!0);for(var fieldId in self.activeFieldset.fields){self.activeFieldset.fields[fieldId].on('change',self._events.changeField).on('syncResponsiveState',(_,screenName)=>{if($usb.find('preview')){$usb.preview.fieldSetResponsiveScreen(screenName)}})}},_destroyFieldset:function(){const self=this;if(!self.selectedGroupId){return}
if(self.$activeFieldset instanceof $){self.$activeFieldset.remove()}
self.$menu.addClass('hidden');self.activeFieldset=null;self.selectedGroupId=null},_changeField:function(usofField){const self=this;if($ush.isUndefined(self.liveOptions[usofField.name])){return}
const isGroup=usofField instanceof $usof.Group;const isField=usofField instanceof $usof.field;if(!(isField||isGroup)){return}
var value=usofField.getValue(),fieldType=(isField?usofField.type:'group'),usbParams=usofField[isField?'$row':'$field'].data('usb-params')||{},instructions=$usb._normalizeInstructions(usbParams.usb_preview);if(fieldType=='typography_options'){value=$ush.toPlainObject(value)}
var oldValue=self.liveOptions[usofField.name];if($.isPlainObject(value)){if($ush.comparePlainObject(oldValue,value)){return}}else if(oldValue===value){return}
self.liveOptions[usofField.name]=value;if(instructions){var _changed=JSON.stringify($usbcore.diffPlainObject(self.liveOptions,_$tmp.savedLiveOptions));$usb.postMessage('onPreviewChange',[instructions,value,fieldType,{changed:$ush.base64Encode(_changed),liveOptions:$ush.toString(self.liveOptions)}])}
$ush.debounce_fn_10ms(()=>{$usb.panel.switchSaveButton(self.isChanged())})},_saveChanges:function(){const self=this;if(self.isProcessSave()||!self.isChanged()||!$usb.urlManager.hasParam('action',$usb.config('actions.site_settings'))){return}
$usb.panel.switchSaveButton(!0,!0);_$tmp.isProcessSave=!0;$usb.ajax('_saveLiveOptions',{data:{_nonce:$usb.config('_nonce'),action:$usb.config('action_save_live_options'),live_options:JSON.stringify(self.liveOptions)},success:(res)=>{if(!res.success){return}
$usb.notify.add($usb.getTextTranslation('site_settings_updated'),NOTIFY_TYPE.SUCCESS);$usb.postMessage('clearCookies');_$tmp.savedLiveOptions=$ush.clone(self.liveOptions)},complete:()=>{_$tmp.isProcessSave=!1;$usb.panel.switchSaveButton(!1)}})}});$usb.siteSettings=new SiteSettings('#usb-site-settings')}(jQuery)